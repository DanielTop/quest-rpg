<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quest RPG</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        @font-face {
            font-family: 'Medieval';
            src: local('Times New Roman');
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #e8d5b7;
            overflow: hidden;
        }

        #game-container {
            width: 100%;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
        }

        /* Header with player info */
        #header {
            background: linear-gradient(180deg, #2d2d44 0%, #1a1a2e 100%);
            border: 3px solid #c9a227;
            border-radius: 10px;
            padding: 15px 20px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5), inset 0 1px 0 rgba(255,255,255,0.1);
        }

        .player-name {
            font-size: 24px;
            font-weight: bold;
            color: #ffd700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .player-stats {
            display: flex;
            gap: 20px;
        }

        .stat-box {
            text-align: center;
            padding: 5px 15px;
            background: rgba(0,0,0,0.3);
            border-radius: 5px;
            border: 1px solid #c9a227;
        }

        .stat-label {
            font-size: 11px;
            color: #a89a7a;
            text-transform: uppercase;
        }

        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #fff;
        }

        .gold-value { color: #ffd700; }
        .level-value { color: #4fc3f7; }

        /* HP/MP bars */
        .bar-container {
            width: 150px;
        }

        .bar {
            height: 20px;
            border-radius: 10px;
            background: #1a1a1a;
            border: 2px solid #555;
            overflow: hidden;
            margin-bottom: 5px;
            position: relative;
        }

        .bar-fill {
            height: 100%;
            transition: width 0.3s ease;
        }

        .hp-fill {
            background: linear-gradient(180deg, #e74c3c 0%, #c0392b 100%);
        }

        .mp-fill {
            background: linear-gradient(180deg, #3498db 0%, #2980b9 100%);
        }

        .bar-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 12px;
            font-weight: bold;
            text-shadow: 1px 1px 2px #000;
        }

        /* Navigation */
        #nav-menu {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .nav-btn {
            padding: 15px 30px;
            font-size: 16px;
            font-weight: bold;
            border: 3px solid #c9a227;
            border-radius: 8px;
            background: linear-gradient(180deg, #4a4a6a 0%, #2d2d44 100%);
            color: #e8d5b7;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        .nav-btn:hover {
            background: linear-gradient(180deg, #5a5a7a 0%, #3d3d54 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.4);
        }

        .nav-btn.active {
            background: linear-gradient(180deg, #c9a227 0%, #a68523 100%);
            color: #1a1a2e;
        }

        /* Main content area */
        #main-content {
            background: linear-gradient(180deg, #2d2d44 0%, #1a1a2e 100%);
            border: 3px solid #c9a227;
            border-radius: 10px;
            padding: 25px;
            min-height: 500px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Screen titles */
        .screen-title {
            text-align: center;
            font-size: 28px;
            color: #ffd700;
            margin-bottom: 25px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            border-bottom: 2px solid #c9a227;
            padding-bottom: 15px;
        }

        /* Castle/Quest screen - ENHANCED */
        .throne-room {
            display: flex;
            gap: 25px;
            margin-bottom: 25px;
        }

        .king-portrait {
            flex-shrink: 0;
            width: 180px;
            background: linear-gradient(145deg, #3d3d5c, #2a2a40);
            border: 4px solid #c9a227;
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5),
                        inset 0 2px 0 rgba(255,255,255,0.1),
                        0 0 20px rgba(201, 162, 39, 0.3);
            position: relative;
            overflow: hidden;
        }

        .king-portrait::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,215,0,0.1), transparent);
            animation: shimmer 3s infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%) rotate(45deg); }
            100% { transform: translateX(100%) rotate(45deg); }
        }

        #king-canvas {
            width: 150px;
            height: 180px;
            display: block;
            margin: 0 auto;
        }

        .king-title {
            text-align: center;
            color: #ffd700;
            font-weight: bold;
            margin-top: 10px;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
        }

        .king-speech-container {
            flex: 1;
        }

        .king-speech {
            background: linear-gradient(135deg, rgba(0,0,0,0.4), rgba(30,30,50,0.6));
            border: 2px solid #c9a227;
            border-radius: 15px;
            padding: 20px 25px;
            font-style: italic;
            font-size: 17px;
            line-height: 1.6;
            position: relative;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.3);
        }

        .king-speech::before {
            content: '"';
            position: absolute;
            top: 5px;
            left: 15px;
            font-size: 60px;
            color: rgba(201, 162, 39, 0.3);
            font-family: Georgia, serif;
        }

        .quest-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            max-height: 450px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .quest-list::-webkit-scrollbar {
            width: 8px;
        }

        .quest-list::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.3);
            border-radius: 4px;
        }

        .quest-list::-webkit-scrollbar-thumb {
            background: #c9a227;
            border-radius: 4px;
        }

        .quest-list::-webkit-scrollbar-thumb:hover {
            background: #dab32f;
        }

        .quest-item {
            background: linear-gradient(145deg, #2d2d44, #1f1f30);
            border: 2px solid #555;
            border-radius: 12px;
            padding: 0;
            cursor: pointer;
            transition: all 0.3s ease;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .quest-item:hover {
            border-color: #c9a227;
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.4), 0 0 15px rgba(201, 162, 39, 0.2);
        }

        .quest-item.completed {
            border-color: #27ae60;
        }

        .quest-header {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: rgba(0,0,0,0.3);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .quest-enemy-portrait {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            border: 2px solid #c9a227;
            background: rgba(0,0,0,0.4);
        }

        .quest-info {
            flex: 1;
        }

        .quest-title {
            font-size: 16px;
            font-weight: bold;
            color: #fff;
            margin-bottom: 3px;
        }

        .quest-target {
            font-size: 12px;
            color: #e74c3c;
        }

        .quest-body {
            padding: 15px;
        }

        .quest-desc {
            font-size: 14px;
            color: #a89a7a;
            margin-bottom: 12px;
        }

        .quest-progress {
            height: 8px;
            background: rgba(0,0,0,0.4);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .quest-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #f39c12, #e67e22);
            transition: width 0.3s;
        }

        .quest-reward {
            display: flex;
            gap: 15px;
            font-size: 13px;
        }

        .reward-item {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            background: rgba(0,0,0,0.3);
            border-radius: 5px;
        }

        .reward-gold { color: #ffd700; }
        .reward-xp { color: #9b59b6; }

        /* Shop screen */
        .shop-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .shop-tab {
            padding: 10px 20px;
            border: 2px solid #555;
            background: rgba(0,0,0,0.3);
            color: #e8d5b7;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.2s;
        }

        .shop-tab:hover, .shop-tab.active {
            border-color: #c9a227;
            background: rgba(201, 162, 39, 0.2);
        }

        .shop-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
        }

        .shop-item {
            background: rgba(0,0,0,0.3);
            border: 2px solid #555;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            transition: all 0.2s;
        }

        .shop-item:hover {
            border-color: #c9a227;
        }

        .shop-item.owned {
            border-color: #27ae60;
        }

        .shop-item.equipped {
            border-color: #3498db;
            box-shadow: 0 0 10px rgba(52, 152, 219, 0.3);
        }

        .item-icon {
            font-size: 40px;
            margin-bottom: 10px;
        }

        .item-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .item-stats {
            font-size: 12px;
            color: #4fc3f7;
            margin-bottom: 10px;
        }

        .item-price {
            color: #ffd700;
            font-weight: bold;
        }

        .buy-btn, .equip-btn {
            margin-top: 10px;
            padding: 8px 20px;
            border: 2px solid #c9a227;
            background: linear-gradient(180deg, #4a4a6a 0%, #2d2d44 100%);
            color: #e8d5b7;
            cursor: pointer;
            border-radius: 5px;
            font-weight: bold;
            transition: all 0.2s;
        }

        .buy-btn:hover, .equip-btn:hover {
            background: linear-gradient(180deg, #c9a227 0%, #a68523 100%);
            color: #1a1a2e;
        }

        .buy-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Character screen */
        .char-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .char-stats-section, .char-equip-section {
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            padding: 20px;
        }

        .section-title {
            font-size: 20px;
            color: #c9a227;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #555;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .stat-name {
            font-size: 16px;
        }

        .stat-row-value {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stat-number {
            font-size: 18px;
            font-weight: bold;
            color: #4fc3f7;
            min-width: 30px;
            text-align: center;
        }

        .stat-up-btn {
            width: 30px;
            height: 30px;
            border: 2px solid #27ae60;
            background: rgba(39, 174, 96, 0.2);
            color: #27ae60;
            border-radius: 5px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            transition: all 0.2s;
        }

        .stat-up-btn:hover {
            background: #27ae60;
            color: #fff;
        }

        .stat-up-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .stat-points {
            text-align: center;
            padding: 15px;
            background: rgba(39, 174, 96, 0.2);
            border: 2px solid #27ae60;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .stat-points-label {
            font-size: 14px;
            color: #a89a7a;
        }

        .stat-points-value {
            font-size: 28px;
            font-weight: bold;
            color: #27ae60;
        }

        .equip-slot {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px;
            background: rgba(0,0,0,0.2);
            border-radius: 5px;
            margin-bottom: 10px;
            border: 1px solid #555;
        }

        .slot-icon {
            font-size: 30px;
            width: 50px;
            text-align: center;
        }

        .slot-info {
            flex: 1;
        }

        .slot-label {
            font-size: 12px;
            color: #a89a7a;
        }

        .slot-item {
            font-weight: bold;
        }

        /* Battle screen */
        .battle-arena {
            position: relative;
            margin-bottom: 20px;
        }

        #battle-canvas {
            width: 100%;
            height: 280px;
            background: linear-gradient(180deg, #1a1a2e 0%, #2d1a3e 50%, #1a2e1a 100%);
            border-radius: 10px;
            border: 2px solid #555;
            display: block;
        }

        .battle-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 15px;
        }

        .combatant-info {
            text-align: center;
            padding: 10px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
        }

        .combatant-info.player-side {
            border: 2px solid #3498db;
        }

        .combatant-info.enemy-side {
            border: 2px solid #e74c3c;
        }

        .combatant-name {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .combatant-hp-bar {
            height: 22px;
            background: #1a1a1a;
            border-radius: 11px;
            overflow: hidden;
            border: 2px solid #555;
            position: relative;
        }

        .battle-actions {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }

        .battle-btn {
            padding: 20px;
            font-size: 16px;
            font-weight: bold;
            border: 3px solid #c9a227;
            border-radius: 8px;
            background: linear-gradient(180deg, #4a4a6a 0%, #2d2d44 100%);
            color: #e8d5b7;
            cursor: pointer;
            transition: all 0.2s;
        }

        .battle-btn:hover:not(:disabled) {
            background: linear-gradient(180deg, #c9a227 0%, #a68523 100%);
            color: #1a1a2e;
            transform: translateY(-2px);
        }

        .battle-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .battle-log {
            background: rgba(0,0,0,0.4);
            border: 2px solid #555;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            max-height: 150px;
            overflow-y: auto;
        }

        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            font-size: 14px;
        }

        .log-entry.player-action { color: #4fc3f7; }
        .log-entry.enemy-action { color: #e74c3c; }
        .log-entry.system { color: #f39c12; }

        /* Arena screen - ENHANCED */
        .arena-info {
            text-align: center;
            margin-bottom: 30px;
            padding: 25px;
            background: linear-gradient(135deg, rgba(0,0,0,0.4), rgba(50,20,20,0.4));
            border: 2px solid #8b0000;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(139,0,0,0.3);
        }

        .arena-tier {
            font-size: 28px;
            color: #ff4444;
            margin-bottom: 10px;
            text-shadow: 0 0 10px rgba(255,68,68,0.5);
        }

        .arena-subtitle {
            color: #a89a7a;
            font-size: 14px;
        }

        .enemy-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            max-height: 500px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .enemy-list::-webkit-scrollbar {
            width: 8px;
        }

        .enemy-list::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.3);
            border-radius: 4px;
        }

        .enemy-list::-webkit-scrollbar-thumb {
            background: #e74c3c;
            border-radius: 4px;
        }

        .enemy-list::-webkit-scrollbar-thumb:hover {
            background: #f15a4a;
        }

        .enemy-card {
            background: linear-gradient(145deg, #2d2d44, #1a1a2e);
            border: 3px solid #444;
            border-radius: 15px;
            padding: 0;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            overflow: hidden;
            position: relative;
            box-shadow: 0 5px 20px rgba(0,0,0,0.4);
        }

        .enemy-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, transparent, #e74c3c, transparent);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .enemy-card:hover {
            border-color: #e74c3c;
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 15px 30px rgba(0,0,0,0.5), 0 0 20px rgba(231,76,60,0.3);
        }

        .enemy-card:hover::before {
            opacity: 1;
        }

        .enemy-card.boss {
            border-color: #9b59b6;
            background: linear-gradient(145deg, #3d2d44, #2a1a2e);
        }

        .enemy-card.boss:hover {
            border-color: #8e44ad;
            box-shadow: 0 15px 30px rgba(0,0,0,0.5), 0 0 25px rgba(142,68,173,0.4);
        }

        .enemy-portrait-container {
            background: linear-gradient(180deg, rgba(0,0,0,0.3), rgba(0,0,0,0.5));
            padding: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .enemy-portrait {
            width: 120px;
            height: 120px;
            margin: 0 auto;
            border-radius: 50%;
            border: 3px solid #555;
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.1), transparent);
            box-shadow: inset 0 -5px 15px rgba(0,0,0,0.5),
                        0 5px 15px rgba(0,0,0,0.3);
            display: block;
        }

        .enemy-card-info {
            padding: 15px;
        }

        .enemy-name {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
            color: #fff;
        }

        .enemy-level {
            display: inline-block;
            padding: 3px 12px;
            background: rgba(0,0,0,0.4);
            border-radius: 10px;
            color: #a89a7a;
            font-size: 12px;
            margin-bottom: 10px;
        }

        .enemy-stats-mini {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 10px;
            font-size: 12px;
        }

        .enemy-stat {
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .enemy-stat-hp { color: #e74c3c; }
        .enemy-stat-atk { color: #f39c12; }
        .enemy-stat-def { color: #3498db; }

        .enemy-reward {
            display: flex;
            justify-content: center;
            gap: 12px;
            font-size: 13px;
            padding: 10px;
            background: rgba(0,0,0,0.3);
            border-radius: 0 0 12px 12px;
        }

        .enemy-reward span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .difficulty-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        .diff-easy { background: #27ae60; color: #fff; }
        .diff-medium { background: #f39c12; color: #fff; }
        .diff-hard { background: #e74c3c; color: #fff; }
        .diff-boss { background: #9b59b6; color: #fff; }

        /* XP Bar */
        .xp-bar-container {
            margin-top: 10px;
        }

        .xp-bar {
            height: 8px;
            background: #1a1a1a;
            border-radius: 4px;
            overflow: hidden;
        }

        .xp-fill {
            height: 100%;
            background: linear-gradient(90deg, #9b59b6, #8e44ad);
            transition: width 0.5s ease;
        }

        .xp-text {
            font-size: 11px;
            color: #a89a7a;
            text-align: center;
            margin-top: 3px;
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 8px;
            font-weight: bold;
            animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s;
            z-index: 1000;
        }

        .notification.success {
            background: #27ae60;
            color: #fff;
        }

        .notification.error {
            background: #e74c3c;
            color: #fff;
        }

        .notification.info {
            background: #3498db;
            color: #fff;
        }

        @keyframes slideIn {
            from { transform: translateX(100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes fadeOut {
            to { opacity: 0; }
        }

        /* Damage numbers */
        .damage-popup {
            position: absolute;
            font-size: 24px;
            font-weight: bold;
            animation: damageFloat 1s ease-out forwards;
            pointer-events: none;
        }

        .damage-popup.player-damage { color: #e74c3c; }
        .damage-popup.enemy-damage { color: #4fc3f7; }
        .damage-popup.heal { color: #27ae60; }
        .damage-popup.critical { color: #f39c12; font-size: 32px; }

        @keyframes damageFloat {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-50px) scale(1.2); opacity: 0; }
        }

        /* Victory/Defeat screens */
        .battle-result {
            text-align: center;
            padding: 40px;
        }

        .result-title {
            font-size: 48px;
            margin-bottom: 20px;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.5);
        }

        .result-title.victory { color: #ffd700; }
        .result-title.defeat { color: #e74c3c; }

        .result-rewards {
            font-size: 20px;
            margin-bottom: 30px;
        }

        .continue-btn {
            padding: 15px 40px;
            font-size: 18px;
            font-weight: bold;
            border: 3px solid #c9a227;
            border-radius: 8px;
            background: linear-gradient(180deg, #c9a227 0%, #a68523 100%);
            color: #1a1a2e;
            cursor: pointer;
            transition: all 0.2s;
        }

        .continue-btn:hover {
            transform: scale(1.05);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .char-layout {
                grid-template-columns: 1fr;
            }

            .battle-arena {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .battle-actions {
                grid-template-columns: repeat(2, 1fr);
            }

            .player-stats {
                flex-wrap: wrap;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <!-- Header -->
        <div id="header">
            <div>
                <div class="player-name" id="player-name">–ì–µ—Ä–æ–π</div>
                <div class="xp-bar-container">
                    <div class="xp-bar">
                        <div class="xp-fill" id="xp-fill" style="width: 0%"></div>
                    </div>
                    <div class="xp-text" id="xp-text">0 / 100 XP</div>
                </div>
            </div>
            <div class="player-stats">
                <div class="stat-box">
                    <div class="stat-label">–£—Ä–æ–≤–µ–Ω—å</div>
                    <div class="stat-value level-value" id="header-level">1</div>
                </div>
                <div class="bar-container">
                    <div class="bar">
                        <div class="bar-fill hp-fill" id="header-hp-fill" style="width: 100%"></div>
                        <div class="bar-text" id="header-hp-text">100/100</div>
                    </div>
                    <div class="bar">
                        <div class="bar-fill mp-fill" id="header-mp-fill" style="width: 100%"></div>
                        <div class="bar-text" id="header-mp-text">50/50</div>
                    </div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">–ó–æ–ª–æ—Ç–æ</div>
                    <div class="stat-value gold-value" id="header-gold">100</div>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div id="nav-menu">
            <button class="nav-btn active" data-screen="castle">–ó–∞–º–æ–∫</button>
            <button class="nav-btn" data-screen="arena">–ê—Ä–µ–Ω–∞</button>
            <button class="nav-btn" data-screen="shop">–ú–∞–≥–∞–∑–∏–Ω</button>
            <button class="nav-btn" data-screen="character">–ü–µ—Ä—Å–æ–Ω–∞–∂</button>
        </div>

        <!-- Main Content -->
        <div id="main-content">
            <!-- Castle Screen -->
            <div id="castle-screen" class="screen active">
                <h2 class="screen-title">üëë –¢—Ä–æ–Ω–Ω—ã–π –ó–∞–ª</h2>
                <div class="throne-room">
                    <div class="king-portrait">
                        <canvas id="king-canvas" width="150" height="180"></canvas>
                        <div class="king-title">–ö–æ—Ä–æ–ª—å –ê–ª—å–¥—Ä–∏–∫ III</div>
                    </div>
                    <div class="king-speech-container">
                        <div class="king-speech" id="king-speech">
                            –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é —Ç–µ–±—è, –≤–æ–∏–Ω! –ù–∞—à–µ –∫–æ—Ä–æ–ª–µ–≤—Å—Ç–≤–æ –Ω—É–∂–¥–∞–µ—Ç—Å—è –≤ —Ç–≤–æ–µ–π –ø–æ–º–æ—â–∏. –í—ã–±–µ—Ä–∏ –∑–∞–¥–∞–Ω–∏–µ –∏ –¥–æ–∫–∞–∂–∏ —Å–≤–æ—é –¥–æ–±–ª–µ—Å—Ç—å!
                        </div>
                    </div>
                </div>
                <h3 style="color:#c9a227; margin-bottom:15px; font-size:20px;">üìú –î–æ—Å—Ç—É–ø–Ω—ã–µ –ó–∞–¥–∞–Ω–∏—è</h3>
                <div class="quest-list" id="quest-list"></div>
            </div>

            <!-- Arena Screen -->
            <div id="arena-screen" class="screen">
                <h2 class="screen-title">‚öîÔ∏è –ê—Ä–µ–Ω–∞ –°–ª–∞–≤—ã</h2>
                <div class="arena-info">
                    <div class="arena-tier" id="arena-tier">üèÜ –†–∞–Ω–≥: –ù–æ–≤–∏—á–æ–∫</div>
                    <p class="arena-subtitle">–í—ã–±–µ—Ä–∏ –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–∞ –∏ –¥–æ–∫–∞–∂–∏ —Å–≤–æ—é —Å–∏–ª—É!</p>
                </div>
                <div class="enemy-list" id="enemy-list"></div>
            </div>

            <!-- Battle Screen -->
            <div id="battle-screen" class="screen">
                <h2 class="screen-title">–ë–û–ô!</h2>
                <div class="battle-arena">
                    <canvas id="battle-canvas" width="850" height="280"></canvas>
                </div>
                <div class="battle-stats">
                    <div class="combatant-info player-side">
                        <div class="combatant-name" id="battle-player-name">–ì–µ—Ä–æ–π</div>
                        <div class="combatant-hp-bar">
                            <div class="bar-fill hp-fill" id="battle-player-hp" style="width: 100%"></div>
                            <div class="bar-text" id="battle-player-hp-text">100/100</div>
                        </div>
                    </div>
                    <div class="combatant-info enemy-side">
                        <div class="combatant-name" id="battle-enemy-name">–í—Ä–∞–≥</div>
                        <div class="combatant-hp-bar">
                            <div class="bar-fill hp-fill" id="battle-enemy-hp" style="width: 100%"></div>
                            <div class="bar-text" id="battle-enemy-hp-text">50/50</div>
                        </div>
                    </div>
                </div>
                <div class="battle-actions" id="battle-actions">
                    <button class="battle-btn" data-action="attack">–ê—Ç–∞–∫–∞</button>
                    <button class="battle-btn" data-action="skill">–£–º–µ–Ω–∏–µ</button>
                    <button class="battle-btn" data-action="defend">–ó–∞—â–∏—Ç–∞</button>
                    <button class="battle-btn" data-action="potion">–ó–µ–ª—å–µ</button>
                </div>
                <div class="battle-log" id="battle-log"></div>
            </div>

            <!-- Battle Result Screen -->
            <div id="result-screen" class="screen">
                <div class="battle-result">
                    <div class="result-title" id="result-title">–ü–û–ë–ï–î–ê!</div>
                    <div class="result-rewards" id="result-rewards"></div>
                    <button class="continue-btn" id="continue-btn">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
                </div>
            </div>

            <!-- Shop Screen -->
            <div id="shop-screen" class="screen">
                <h2 class="screen-title">–ú–∞–≥–∞–∑–∏–Ω</h2>
                <div class="shop-tabs">
                    <button class="shop-tab active" data-tab="weapons">–û—Ä—É–∂–∏–µ</button>
                    <button class="shop-tab" data-tab="armor">–ë—Ä–æ–Ω—è</button>
                    <button class="shop-tab" data-tab="potions">–ó–µ–ª—å—è</button>
                </div>
                <div class="shop-items" id="shop-items"></div>
            </div>

            <!-- Character Screen -->
            <div id="character-screen" class="screen">
                <h2 class="screen-title">–ü–µ—Ä—Å–æ–Ω–∞–∂</h2>
                <div class="char-layout">
                    <div class="char-stats-section">
                        <div class="stat-points" id="stat-points-container">
                            <div class="stat-points-label">–û—á–∫–∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫</div>
                            <div class="stat-points-value" id="stat-points">0</div>
                        </div>
                        <h3 class="section-title">–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏</h3>
                        <div id="stats-list"></div>
                    </div>
                    <div class="char-equip-section">
                        <h3 class="section-title">–°–Ω–∞—Ä—è–∂–µ–Ω–∏–µ</h3>
                        <div id="equipment-list"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===================== GAME DATA =====================
        const GameData = {
            weapons: [
                { id: 'w1', name: '–î–µ—Ä–µ–≤—è–Ω–Ω—ã–π –º–µ—á', icon: 'üó°Ô∏è', attack: 5, price: 0, owned: true },
                { id: 'w2', name: '–ñ–µ–ª–µ–∑–Ω—ã–π –º–µ—á', icon: '‚öîÔ∏è', attack: 12, price: 150 },
                { id: 'w3', name: '–°—Ç–∞–ª—å–Ω–æ–π –º–µ—á', icon: 'üî™', attack: 20, price: 400 },
                { id: 'w4', name: '–°–µ—Ä–µ–±—Ä—è–Ω—ã–π –∫–ª–∏–Ω–æ–∫', icon: 'üó°Ô∏è', attack: 35, price: 800 },
                { id: 'w5', name: '–û–≥–Ω–µ–Ω–Ω—ã–π –º–µ—á', icon: 'üî•', attack: 50, price: 1500 },
                { id: 'w6', name: '–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π –º–µ—á', icon: '‚ö°', attack: 80, price: 3000 },
            ],
            armor: [
                { id: 'a1', name: '–¢—Ä—è–ø—å—ë', icon: 'üëï', defense: 2, price: 0, owned: true },
                { id: 'a2', name: '–ö–æ–∂–∞–Ω–∞—è –±—Ä–æ–Ω—è', icon: 'ü•ã', defense: 8, price: 120 },
                { id: 'a3', name: '–ö–æ–ª—å—á—É–≥–∞', icon: 'üõ°Ô∏è', defense: 15, price: 350 },
                { id: 'a4', name: '–°—Ç–∞–ª—å–Ω–∞—è –±—Ä–æ–Ω—è', icon: 'ü¶∫', defense: 25, price: 700 },
                { id: 'a5', name: '–†—ã—Ü–∞—Ä—Å–∫–∏–µ –¥–æ—Å–ø–µ—Ö–∏', icon: '‚öîÔ∏è', defense: 40, price: 1200 },
                { id: 'a6', name: '–î—Ä–∞–∫–æ–Ω—å—è –±—Ä–æ–Ω—è', icon: 'üêâ', defense: 60, price: 2500 },
            ],
            potions: [
                { id: 'p1', name: '–ú–∞–ª–æ–µ –∑–µ–ª—å–µ HP', icon: 'üß™', heal: 50, price: 25 },
                { id: 'p2', name: '–°—Ä–µ–¥–Ω–µ–µ –∑–µ–ª—å–µ HP', icon: 'üß™', heal: 150, price: 75 },
                { id: 'p3', name: '–ë–æ–ª—å—à–æ–µ –∑–µ–ª—å–µ HP', icon: 'üß™', heal: 400, price: 200 },
                { id: 'p4', name: '–ó–µ–ª—å–µ –º–∞–Ω—ã', icon: 'üíß', mana: 30, price: 40 },
            ],
            enemies: [
                { id: 'e1', name: '–°–ª–∞–±—ã–π –≥–æ–±–ª–∏–Ω', icon: 'üë∫', level: 1, hp: 40, attack: 8, defense: 2, xp: 20, gold: 15, desc: '–ú–µ–ª–∫–∏–π –∑–µ–ª—ë–Ω—ã–π –ø–∞–∫–æ—Å—Ç–Ω–∏–∫' },
                { id: 'e2', name: '–ö—Ä—ã—Å–∞', icon: 'üêÄ', level: 2, hp: 30, attack: 12, defense: 3, xp: 25, gold: 20, desc: '–û–≥—Ä–æ–º–Ω–∞—è –ø–æ–¥–≤–∞–ª—å–Ω–∞—è –∫—Ä—ã—Å–∞' },
                { id: 'e9', name: '–î–∏–∫–∏–π –≤–æ–ª–∫', icon: 'üê∫', level: 2, hp: 45, attack: 14, defense: 4, xp: 30, gold: 25, desc: '–ì–æ–ª–æ–¥–Ω—ã–π –ª–µ—Å–Ω–æ–π —Ö–∏—â–Ω–∏–∫' },
                { id: 'e3', name: '–°–∫–µ–ª–µ—Ç', icon: 'üíÄ', level: 3, hp: 60, attack: 15, defense: 5, xp: 40, gold: 35, desc: '–û–∂–∏–≤—à–∏–π –≤–æ–∏–Ω –ø—Ä–æ—à–ª–æ–≥–æ' },
                { id: 'e10', name: '–ü—Ä–∏–∑—Ä–∞–∫', icon: 'üëª', level: 4, hp: 50, attack: 18, defense: 3, xp: 50, gold: 45, desc: '–ù–µ—É–ø–æ–∫–æ–µ–Ω–Ω–∞—è –¥—É—à–∞' },
                { id: 'e4', name: '–û—Ä–∫', icon: 'üëπ', level: 5, hp: 100, attack: 22, defense: 10, xp: 70, gold: 60, desc: '–ú–æ–≥—É—á–∏–π –∑–µ–ª–µ–Ω–æ–∫–æ–∂–∏–π –≤–æ–∏–Ω' },
                { id: 'e11', name: '–ü–∞—É–∫-–≥–∏–≥–∞–Ω—Ç', icon: 'üï∑Ô∏è', level: 6, hp: 80, attack: 25, defense: 8, xp: 85, gold: 75, desc: '–Ø–¥–æ–≤–∏—Ç—ã–π –æ–±–∏—Ç–∞—Ç–µ–ª—å –ø–µ—â–µ—Ä' },
                { id: 'e5', name: '–¢—Ä–æ–ª–ª—å', icon: 'üßå', level: 7, hp: 180, attack: 30, defense: 15, xp: 120, gold: 100, desc: '–û–≥—Ä–æ–º–Ω—ã–π —Ä–µ–≥–µ–Ω–µ—Ä–∏—Ä—É—é—â–∏–π –º–æ–Ω—Å—Ç—Ä' },
                { id: 'e12', name: '–ú–µ–¥—É–∑–∞', icon: 'üêç', level: 8, hp: 120, attack: 35, defense: 12, xp: 150, gold: 130, desc: '–í–∑–≥–ª—è–¥ –æ–±—Ä–∞—â–∞–µ—Ç –≤ –∫–∞–º–µ–Ω—å' },
                { id: 'e6', name: '–¢—ë–º–Ω—ã–π –º–∞–≥', icon: 'üßô‚Äç‚ôÇÔ∏è', level: 10, hp: 150, attack: 45, defense: 12, xp: 200, gold: 180, boss: true, desc: '–ü–æ–≤–µ–ª–∏—Ç–µ–ª—å —Ç—ë–º–Ω—ã—Ö –∏—Å–∫—É—Å—Å—Ç–≤' },
                { id: 'e7', name: '–ú–∏–Ω–æ—Ç–∞–≤—Ä', icon: 'üêÇ', level: 12, hp: 300, attack: 40, defense: 25, xp: 300, gold: 250, boss: true, desc: '–°—Ç—Ä–∞–∂ –ª–∞–±–∏—Ä–∏–Ω—Ç–∞' },
                { id: 'e13', name: '–î–µ–º–æ–Ω', icon: 'üëø', level: 14, hp: 400, attack: 55, defense: 30, xp: 400, gold: 400, boss: true, desc: '–ü–æ—Ä–æ–∂–¥–µ–Ω–∏–µ –∞–¥–∞' },
                { id: 'e8', name: '–î—Ä–∞–∫–æ–Ω', icon: 'üêâ', level: 15, hp: 500, attack: 60, defense: 35, xp: 500, gold: 500, boss: true, desc: '–î—Ä–µ–≤–Ω–∏–π –ø–æ–≤–µ–ª–∏—Ç–µ–ª—å –æ–≥–Ω—è' },
                { id: 'e14', name: '–õ–∏—á', icon: '‚ò†Ô∏è', level: 18, hp: 450, attack: 70, defense: 28, xp: 650, gold: 700, boss: true, desc: '–ë–µ—Å—Å–º–µ—Ä—Ç–Ω—ã–π –Ω–µ–∫—Ä–æ–º–∞–Ω—Ç' },
                { id: 'e15', name: '–¢—ë–º–Ω—ã–π –õ–æ—Ä–¥', icon: 'ü¶π', level: 20, hp: 800, attack: 85, defense: 45, xp: 1000, gold: 1000, boss: true, desc: '–î—Ä–µ–≤–Ω–µ–µ –ó–ª–æ –ø—Ä–æ–±—É–¥–∏–ª–æ—Å—å' },
            ],
            quests: [
                {
                    id: 'q1',
                    title: '–ü–µ—Ä–≤–∞—è –∫—Ä–æ–≤—å',
                    desc: '–î–æ–∫–∞–∂–∏ —á—Ç–æ –¥–æ—Å—Ç–æ–∏–Ω –∑–≤–∞–Ω–∏—è –≤–æ–∏–Ω–∞',
                    target: { type: 'kill', enemy: 'e1', count: 3 },
                    reward: { gold: 100, xp: 50 },
                    completed: false,
                    progress: 0
                },
                {
                    id: 'q6',
                    title: '–ö—Ä—ã—Å–∏–Ω–∞—è –Ω–∞–ø–∞—Å—Ç—å',
                    desc: '–û—á–∏—Å—Ç–∏ –ø–æ–¥–≤–∞–ª—ã –∑–∞–º–∫–∞ –æ—Ç –≥—Ä—ã–∑—É–Ω–æ–≤',
                    target: { type: 'kill', enemy: 'e2', count: 5 },
                    reward: { gold: 120, xp: 60 },
                    completed: false,
                    progress: 0
                },
                {
                    id: 'q7',
                    title: '–í–æ–ª—á—å—è —Å—Ç–∞—è',
                    desc: '–ó–∞—â–∏—Ç–∏ –¥–µ—Ä–µ–≤–Ω—é –æ—Ç –≤–æ–ª–∫–æ–≤',
                    target: { type: 'kill', enemy: 'e9', count: 4 },
                    reward: { gold: 150, xp: 80 },
                    completed: false,
                    progress: 0
                },
                {
                    id: 'q2',
                    title: '–û—á–∏—Å—Ç–∫–∞ –ø–æ–¥–∑–µ–º–µ–ª–∏–π',
                    desc: '–£–ø–æ–∫–æ–π –≤–æ—Å—Å—Ç–∞–≤—à–∏—Ö –º–µ—Ä—Ç–≤–µ—Ü–æ–≤',
                    target: { type: 'kill', enemy: 'e3', count: 5 },
                    reward: { gold: 200, xp: 100 },
                    completed: false,
                    progress: 0
                },
                {
                    id: 'q8',
                    title: '–ò–∑–≥–Ω–∞–Ω–∏–µ –¥—É—Ö–æ–≤',
                    desc: '–û—Å–≤–æ–±–æ–¥–∏ —Å—Ç–∞—Ä–æ–µ –∫–ª–∞–¥–±–∏—â–µ –æ—Ç –ø—Ä–∏–∑—Ä–∞–∫–æ–≤',
                    target: { type: 'kill', enemy: 'e10', count: 3 },
                    reward: { gold: 250, xp: 130 },
                    completed: false,
                    progress: 0
                },
                {
                    id: 'q3',
                    title: '–û—Ä–æ—á—å—è —É–≥—Ä–æ–∑–∞',
                    desc: '–û—Å—Ç–∞–Ω–æ–≤–∏ –Ω–∞–±–µ–≥ –æ—Ä–∫–æ–≤ –Ω–∞ –≥—Ä–∞–Ω–∏—Ü–µ',
                    target: { type: 'kill', enemy: 'e4', count: 3 },
                    reward: { gold: 350, xp: 180 },
                    completed: false,
                    progress: 0
                },
                {
                    id: 'q9',
                    title: '–õ–æ–≥–æ–≤–æ –ø–∞—É–∫–æ–≤',
                    desc: '–ó–∞—á–∏—Å—Ç–∏ –ø–µ—â–µ—Ä—ã –æ—Ç –≥–∏–≥–∞–Ω—Ç—Å–∫–∏—Ö –ø–∞—É–∫–æ–≤',
                    target: { type: 'kill', enemy: 'e11', count: 4 },
                    reward: { gold: 400, xp: 220 },
                    completed: false,
                    progress: 0
                },
                {
                    id: 'q4',
                    title: '–û—Ö–æ—Ç–∞ –Ω–∞ —Ç—Ä–æ–ª–ª–µ–π',
                    desc: '–ò—Å—Ç—Ä–µ–±–∏ —Ç—Ä–æ–ª–ª–µ–π –≤ –≥–æ—Ä–∞—Ö',
                    target: { type: 'kill', enemy: 'e5', count: 2 },
                    reward: { gold: 500, xp: 300 },
                    completed: false,
                    progress: 0
                },
                {
                    id: 'q10',
                    title: '–ö–∞–º–µ–Ω–Ω—ã–π –≤–∑–≥–ª—è–¥',
                    desc: '–£–±–µ–π –º–µ–¥—É–∑—É –≤ –±–æ–ª–æ—Ç–∞—Ö',
                    target: { type: 'kill', enemy: 'e12', count: 1 },
                    reward: { gold: 600, xp: 350 },
                    completed: false,
                    progress: 0
                },
                {
                    id: 'q11',
                    title: '–¢—ë–º–Ω–∞—è –±–∞—à–Ω—è',
                    desc: '–ü–æ–±–µ–¥–∏ —Ç—ë–º–Ω–æ–≥–æ –º–∞–≥–∞ –≤ –µ–≥–æ –±–∞—à–Ω–µ',
                    target: { type: 'kill', enemy: 'e6', count: 1 },
                    reward: { gold: 700, xp: 400 },
                    completed: false,
                    progress: 0
                },
                {
                    id: 'q12',
                    title: '–õ–∞–±–∏—Ä–∏–Ω—Ç —É–∂–∞—Å–∞',
                    desc: '–°—Ä–∞–∑–∏—Å—å —Å –º–∏–Ω–æ—Ç–∞–≤—Ä–æ–º-—Å—Ç—Ä–∞–∂–µ–º',
                    target: { type: 'kill', enemy: 'e7', count: 1 },
                    reward: { gold: 800, xp: 500 },
                    completed: false,
                    progress: 0
                },
                {
                    id: 'q13',
                    title: '–í—Ä–∞—Ç–∞ –∞–¥–∞',
                    desc: '–ó–∞–∫—Ä–æ–π –ø–æ—Ä—Ç–∞–ª - —É–±–µ–π –¥–µ–º–æ–Ω–∞',
                    target: { type: 'kill', enemy: 'e13', count: 1 },
                    reward: { gold: 900, xp: 600 },
                    completed: false,
                    progress: 0
                },
                {
                    id: 'q5',
                    title: '–î—Ä–∞–∫–æ–Ω–æ–±–æ—Ä–µ—Ü',
                    desc: '–ü–æ–±–µ–¥–∏ –¥—Ä–µ–≤–Ω–µ–≥–æ –¥—Ä–∞–∫–æ–Ω–∞!',
                    target: { type: 'kill', enemy: 'e8', count: 1 },
                    reward: { gold: 1000, xp: 800 },
                    completed: false,
                    progress: 0
                },
                {
                    id: 'q14',
                    title: '–°–º–µ—Ä—Ç—å –±–µ—Å—Å–º–µ—Ä—Ç–Ω–æ–º—É',
                    desc: '–£–Ω–∏—á—Ç–æ–∂—å —Ñ–∏–ª–∞–∫—Ç–µ—Ä–∏—é –ª–∏—á–∞',
                    target: { type: 'kill', enemy: 'e14', count: 1 },
                    reward: { gold: 1500, xp: 1000 },
                    completed: false,
                    progress: 0
                },
                {
                    id: 'q15',
                    title: '–ö–æ–Ω–µ—Ü –¢—å–º—ã',
                    desc: '–°–≤–µ—Ä–≥–∏ –¢—ë–º–Ω–æ–≥–æ –õ–æ—Ä–¥–∞ –Ω–∞–≤—Å–µ–≥–¥–∞!',
                    target: { type: 'kill', enemy: 'e15', count: 1 },
                    reward: { gold: 2500, xp: 2000 },
                    completed: false,
                    progress: 0
                },
            ]
        };

        // ===================== PLAYER STATE =====================
        let Player = {
            name: '–ì–µ—Ä–æ–π',
            level: 1,
            xp: 0,
            xpToNext: 100,
            gold: 100,
            hp: 100,
            maxHp: 100,
            mp: 50,
            maxMp: 50,
            potions: 3,
            manaPotions: 1,
            statPoints: 0,
            stats: {
                strength: 5,     // +2 attack per point
                vitality: 5,     // +10 HP per point
                agility: 5,      // +1% crit chance, +1 defense
                intelligence: 5  // +5 MP per point, +skill damage
            },
            equipment: {
                weapon: 'w1',
                armor: 'a1'
            },
            ownedItems: ['w1', 'a1']
        };

        // ===================== BATTLE STATE =====================
        let Battle = {
            active: false,
            enemy: null,
            enemyHp: 0,
            enemyMaxHp: 0,
            playerDefending: false,
            turn: 'player',
            questEnemy: null
        };

        // ===================== EPIC STICKMAN ANIMATION SYSTEM =====================
        const BattleAnim = {
            canvas: null,
            ctx: null,
            animationId: null,

            // Stickman positions
            player: { x: 180, y: 180, baseX: 180, baseY: 180 },
            enemy: { x: 670, y: 180, baseX: 670, baseY: 180 },

            // Animation states
            playerAnim: { type: 'idle', frame: 0, duration: 0 },
            enemyAnim: { type: 'idle', frame: 0, duration: 0 },

            // Particle systems
            particles: [],
            slashEffects: [],
            sparks: [],
            dustClouds: [],

            // Screen shake
            shake: { x: 0, y: 0, intensity: 0 },

            // Clouds for background
            clouds: [],

            // Combo counter
            combo: 0,
            comboTimer: 0,

            // Time for animations
            time: 0,

            // Damage popups
            popups: [],

            // Weapon colors based on weapon ID
            weaponStyles: {
                'w1': { color: '#8B4513', glow: null, name: 'wood', trail: '#A0522D' },
                'w2': { color: '#A0A0A0', glow: null, name: 'iron', trail: '#808080' },
                'w3': { color: '#C0C0C0', glow: '#E0E0E0', name: 'steel', trail: '#FFFFFF' },
                'w4': { color: '#E8E8E8', glow: '#FFFFFF', name: 'silver', trail: '#F0F0FF' },
                'w5': { color: '#FF6600', glow: '#FF0000', name: 'fire', trail: '#FFCC00' },
                'w6': { color: '#FFD700', glow: '#FFFF00', name: 'legend', trail: '#FFFF88' }
            },

            // Enemy types for different drawings
            enemyTypes: {
                'e1': { color: '#4CAF50', type: 'goblin', size: 0.8 },
                'e2': { color: '#795548', type: 'rat', size: 0.6 },
                'e9': { color: '#607D8B', type: 'wolf', size: 0.9 },
                'e3': { color: '#ECEFF1', type: 'skeleton', size: 1 },
                'e10': { color: '#B0BEC5', type: 'ghost', size: 1 },
                'e4': { color: '#8BC34A', type: 'orc', size: 1.3 },
                'e11': { color: '#4A148C', type: 'spider', size: 1.1 },
                'e5': { color: '#607D8B', type: 'troll', size: 1.5 },
                'e12': { color: '#4CAF50', type: 'medusa', size: 1.2 },
                'e6': { color: '#9C27B0', type: 'mage', size: 1 },
                'e7': { color: '#795548', type: 'minotaur', size: 1.6 },
                'e13': { color: '#B71C1C', type: 'demon', size: 1.4 },
                'e8': { color: '#F44336', type: 'dragon', size: 1.8 },
                'e14': { color: '#1A237E', type: 'lich', size: 1.3 },
                'e15': { color: '#000000', type: 'darklord', size: 2.0 }
            },

            init() {
                this.canvas = document.getElementById('battle-canvas');
                this.ctx = this.canvas.getContext('2d');
                // Init clouds
                this.clouds = [];
                for (let i = 0; i < 5; i++) {
                    this.clouds.push({
                        x: Math.random() * this.canvas.width,
                        y: 20 + Math.random() * 60,
                        size: 30 + Math.random() * 40,
                        speed: 0.2 + Math.random() * 0.3
                    });
                }
            },

            start() {
                this.player.x = this.player.baseX;
                this.player.y = this.player.baseY;
                this.enemy.x = this.enemy.baseX;
                this.enemy.y = this.enemy.baseY;
                this.playerAnim = { type: 'idle', frame: 0, duration: 0 };
                this.enemyAnim = { type: 'idle', frame: 0, duration: 0 };
                this.popups = [];
                this.particles = [];
                this.slashEffects = [];
                this.sparks = [];
                this.dustClouds = [];
                this.shake = { x: 0, y: 0, intensity: 0 };
                this.combo = 0;
                this.comboTimer = 0;
                this.time = 0;
                this.animate();
            },

            stop() {
                if (this.animationId) {
                    cancelAnimationFrame(this.animationId);
                    this.animationId = null;
                }
            },

            animate() {
                this.time++;
                this.update();
                this.draw();
                this.animationId = requestAnimationFrame(() => this.animate());
            },

            // Spawn particles
            spawnDust(x, y, count = 5) {
                for (let i = 0; i < count; i++) {
                    this.dustClouds.push({
                        x: x + (Math.random() - 0.5) * 30,
                        y: y + Math.random() * 10,
                        vx: (Math.random() - 0.5) * 2,
                        vy: -Math.random() * 2,
                        size: 5 + Math.random() * 10,
                        alpha: 0.6,
                        color: '#8B7355'
                    });
                }
            },

            spawnSparks(x, y, count = 8, color = '#FFD700') {
                for (let i = 0; i < count; i++) {
                    const angle = Math.random() * Math.PI * 2;
                    const speed = 3 + Math.random() * 5;
                    this.sparks.push({
                        x, y,
                        vx: Math.cos(angle) * speed,
                        vy: Math.sin(angle) * speed - 2,
                        size: 2 + Math.random() * 3,
                        alpha: 1,
                        color: color
                    });
                }
            },

            spawnSlash(x, y, angle, color = '#FFFFFF') {
                this.slashEffects.push({
                    x, y, angle,
                    progress: 0,
                    color: color,
                    length: 80
                });
            },

            spawnMagicParticles(x, y, color = '#E040FB') {
                for (let i = 0; i < 15; i++) {
                    const angle = Math.random() * Math.PI * 2;
                    const dist = Math.random() * 30;
                    this.particles.push({
                        x: x + Math.cos(angle) * dist,
                        y: y + Math.sin(angle) * dist,
                        vx: Math.cos(angle) * 2,
                        vy: Math.sin(angle) * 2 - 1,
                        size: 3 + Math.random() * 5,
                        alpha: 1,
                        color: color,
                        glow: true
                    });
                }
            },

            triggerShake(intensity = 10) {
                this.shake.intensity = intensity;
            },

            update() {
                // Update screen shake
                if (this.shake.intensity > 0) {
                    this.shake.x = (Math.random() - 0.5) * this.shake.intensity;
                    this.shake.y = (Math.random() - 0.5) * this.shake.intensity;
                    this.shake.intensity *= 0.9;
                    if (this.shake.intensity < 0.5) this.shake.intensity = 0;
                } else {
                    this.shake.x = 0;
                    this.shake.y = 0;
                }

                // Update combo timer
                if (this.comboTimer > 0) {
                    this.comboTimer--;
                    if (this.comboTimer <= 0) this.combo = 0;
                }

                // Update clouds
                this.clouds.forEach(c => {
                    c.x += c.speed;
                    if (c.x > this.canvas.width + 50) c.x = -50;
                });

                // Update player animation
                if (this.playerAnim.duration > 0) {
                    this.playerAnim.frame++;
                    this.playerAnim.duration--;

                    if (this.playerAnim.type === 'attack') {
                        const progress = this.playerAnim.frame / 30;
                        if (progress < 0.4) {
                            this.player.x = this.player.baseX + (progress / 0.4) * 150;
                            // Spawn dust while moving
                            if (this.playerAnim.frame % 3 === 0) this.spawnDust(this.player.x - 30, 230);
                        } else if (progress < 0.5) {
                            this.player.x = this.player.baseX + 150;
                            // Slash effect at impact
                            if (this.playerAnim.frame === 15) {
                                const weapon = this.weaponStyles[Player.equipment.weapon] || this.weaponStyles['w1'];
                                this.spawnSlash(this.enemy.baseX - 40, 140, -0.3, weapon.trail);
                                this.spawnSparks(this.enemy.baseX - 20, 150, 12, weapon.glow || '#FFAA00');
                                this.triggerShake(8);
                            }
                        } else {
                            this.player.x = this.player.baseX + 150 * (1 - (progress - 0.5) / 0.5);
                        }
                    } else if (this.playerAnim.type === 'skill') {
                        const progress = this.playerAnim.frame / 40;
                        if (progress < 0.4) {
                            this.player.x = this.player.baseX + progress * 250;
                            this.player.y = 180 - Math.sin(progress * Math.PI * 2.5) * 100;
                            if (this.playerAnim.frame % 2 === 0) {
                                this.spawnMagicParticles(this.player.x, this.player.y, '#4fc3f7');
                            }
                        } else if (progress < 0.5) {
                            this.player.x = this.player.baseX + 250;
                            this.player.y = 180;
                            if (this.playerAnim.frame === 20) {
                                const weapon = this.weaponStyles[Player.equipment.weapon] || this.weaponStyles['w1'];
                                this.spawnSlash(this.enemy.baseX - 30, 120, -0.5, '#E040FB');
                                this.spawnSlash(this.enemy.baseX - 20, 160, 0.3, weapon.trail);
                                this.spawnSparks(this.enemy.baseX, 140, 20, '#E040FB');
                                this.spawnMagicParticles(this.enemy.baseX, 140, '#E040FB');
                                this.triggerShake(15);
                            }
                        } else {
                            this.player.x = this.player.baseX + 250 * (1 - (progress - 0.5) / 0.5);
                            this.player.y = 180;
                        }
                    } else if (this.playerAnim.type === 'defend') {
                        this.player.x = this.player.baseX + Math.sin(this.playerAnim.frame * 0.5) * 5;
                        if (this.playerAnim.frame % 5 === 0) {
                            this.particles.push({
                                x: this.player.x + 20,
                                y: 130 + Math.random() * 40,
                                vx: 0.5,
                                vy: -1,
                                size: 5,
                                alpha: 0.8,
                                color: '#4fc3f7',
                                glow: true
                            });
                        }
                    } else if (this.playerAnim.type === 'hit') {
                        const progress = this.playerAnim.frame / 20;
                        if (progress < 0.3) {
                            this.player.x = this.player.baseX - 40 * (progress / 0.3);
                            if (this.playerAnim.frame === 1) {
                                this.spawnSparks(this.player.x + 20, 150, 10, '#FF6B6B');
                                this.triggerShake(12);
                            }
                        } else {
                            this.player.x = this.player.baseX - 40 * (1 - (progress - 0.3) / 0.7);
                        }
                    } else if (this.playerAnim.type === 'heal') {
                        if (this.playerAnim.frame % 3 === 0) {
                            const angle = Math.random() * Math.PI * 2;
                            this.particles.push({
                                x: this.player.x + Math.cos(angle) * 30,
                                y: 180 + Math.sin(angle) * 30,
                                vx: 0,
                                vy: -2 - Math.random(),
                                size: 4 + Math.random() * 4,
                                alpha: 1,
                                color: '#27ae60',
                                glow: true
                            });
                        }
                    }
                } else {
                    this.playerAnim.type = 'idle';
                    this.player.x = this.player.baseX;
                    this.player.y = 180;
                }

                // Update enemy animation
                if (this.enemyAnim.duration > 0) {
                    this.enemyAnim.frame++;
                    this.enemyAnim.duration--;

                    if (this.enemyAnim.type === 'attack') {
                        const progress = this.enemyAnim.frame / 30;
                        if (progress < 0.4) {
                            this.enemy.x = this.enemy.baseX - (progress / 0.4) * 150;
                            if (this.enemyAnim.frame % 3 === 0) this.spawnDust(this.enemy.x + 30, 230);
                        } else if (progress < 0.5) {
                            this.enemy.x = this.enemy.baseX - 150;
                            if (this.enemyAnim.frame === 15) {
                                this.spawnSlash(this.player.baseX + 40, 140, 0.3, '#FF4444');
                                this.spawnSparks(this.player.baseX + 20, 150, 10, '#FF6B6B');
                            }
                        } else {
                            this.enemy.x = this.enemy.baseX - 150 * (1 - (progress - 0.5) / 0.5);
                        }
                    } else if (this.enemyAnim.type === 'hit') {
                        const progress = this.enemyAnim.frame / 20;
                        if (progress < 0.3) {
                            this.enemy.x = this.enemy.baseX + 40 * (progress / 0.3);
                        } else {
                            this.enemy.x = this.enemy.baseX + 40 * (1 - (progress - 0.3) / 0.7);
                        }
                    } else if (this.enemyAnim.type === 'death') {
                        // Dramatic death
                        if (this.enemyAnim.frame < 10) {
                            this.enemy.x = this.enemy.baseX + Math.sin(this.enemyAnim.frame * 2) * 10;
                        }
                        if (this.enemyAnim.frame % 5 === 0 && this.enemyAnim.frame < 30) {
                            this.spawnSparks(this.enemy.x, 140, 5, '#FF0000');
                        }
                    }
                } else {
                    this.enemyAnim.type = 'idle';
                    this.enemy.x = this.enemy.baseX;
                }

                // Update particles
                this.particles = this.particles.filter(p => {
                    p.x += p.vx;
                    p.y += p.vy;
                    p.vy += 0.05; // gravity
                    p.alpha -= 0.02;
                    return p.alpha > 0;
                });

                // Update sparks
                this.sparks = this.sparks.filter(s => {
                    s.x += s.vx;
                    s.y += s.vy;
                    s.vy += 0.15;
                    s.alpha -= 0.03;
                    s.size *= 0.97;
                    return s.alpha > 0 && s.size > 0.5;
                });

                // Update dust
                this.dustClouds = this.dustClouds.filter(d => {
                    d.x += d.vx;
                    d.y += d.vy;
                    d.size += 0.5;
                    d.alpha -= 0.02;
                    return d.alpha > 0;
                });

                // Update slash effects
                this.slashEffects = this.slashEffects.filter(s => {
                    s.progress += 0.15;
                    return s.progress < 1;
                });

                // Update popups
                this.popups = this.popups.filter(p => {
                    p.y -= 1.5;
                    p.alpha -= 0.015;
                    p.scale = Math.min(1.2, p.scale + 0.02);
                    return p.alpha > 0;
                });
            },

            draw() {
                const ctx = this.ctx;
                ctx.save();

                // Apply screen shake
                ctx.translate(this.shake.x, this.shake.y);

                ctx.clearRect(-20, -20, this.canvas.width + 40, this.canvas.height + 40);

                // Draw epic background
                this.drawBackground();

                // Draw dust clouds (behind characters)
                this.dustClouds.forEach(d => {
                    ctx.globalAlpha = d.alpha;
                    ctx.fillStyle = d.color;
                    ctx.beginPath();
                    ctx.arc(d.x, d.y, d.size, 0, Math.PI * 2);
                    ctx.fill();
                });
                ctx.globalAlpha = 1;

                // Draw shadows
                this.drawShadow(this.player.x, 230, 35);
                this.drawShadow(this.enemy.x, 230, 40);

                // Draw player stickman
                this.drawPlayerStickman(this.player.x, this.player.y);

                // Draw enemy stickman
                this.drawEnemyStickman(this.enemy.x, this.enemy.y);

                // Draw slash effects
                this.slashEffects.forEach(s => {
                    this.drawSlash(s);
                });

                // Draw sparks
                this.sparks.forEach(s => {
                    ctx.globalAlpha = s.alpha;
                    ctx.fillStyle = s.color;
                    ctx.shadowColor = s.color;
                    ctx.shadowBlur = 5;
                    ctx.beginPath();
                    ctx.arc(s.x, s.y, s.size, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.shadowBlur = 0;
                });
                ctx.globalAlpha = 1;

                // Draw particles
                this.particles.forEach(p => {
                    ctx.globalAlpha = p.alpha;
                    if (p.glow) {
                        ctx.shadowColor = p.color;
                        ctx.shadowBlur = 10;
                    }
                    ctx.fillStyle = p.color;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.shadowBlur = 0;
                });
                ctx.globalAlpha = 1;

                // Draw combo counter
                if (this.combo > 1) {
                    ctx.save();
                    ctx.font = 'bold 24px Arial';
                    ctx.fillStyle = '#FFD700';
                    ctx.shadowColor = '#FF6600';
                    ctx.shadowBlur = 10;
                    ctx.textAlign = 'center';
                    const comboScale = 1 + Math.sin(this.time * 0.2) * 0.1;
                    ctx.translate(this.canvas.width / 2, 40);
                    ctx.scale(comboScale, comboScale);
                    ctx.fillText(`${this.combo}x COMBO!`, 0, 0);
                    ctx.restore();
                }

                // Draw damage popups
                this.popups.forEach(p => {
                    ctx.save();
                    ctx.globalAlpha = p.alpha;
                    ctx.font = `bold ${(p.size || 24) * (p.scale || 1)}px Arial`;
                    ctx.fillStyle = p.color;
                    ctx.strokeStyle = '#000';
                    ctx.lineWidth = 4;
                    ctx.textAlign = 'center';
                    ctx.shadowColor = p.color;
                    ctx.shadowBlur = 10;
                    ctx.strokeText(p.text, p.x, p.y);
                    ctx.fillText(p.text, p.x, p.y);
                    ctx.restore();
                });

                ctx.restore();
            },

            drawBackground() {
                const ctx = this.ctx;

                // Sky gradient
                const skyGrad = ctx.createLinearGradient(0, 0, 0, 220);
                skyGrad.addColorStop(0, '#1a0a2e');
                skyGrad.addColorStop(0.5, '#2d1a4e');
                skyGrad.addColorStop(1, '#4a2a6e');
                ctx.fillStyle = skyGrad;
                ctx.fillRect(0, 0, this.canvas.width, 220);

                // Stars
                ctx.fillStyle = '#FFFFFF';
                for (let i = 0; i < 30; i++) {
                    const x = (i * 73 + this.time * 0.1) % this.canvas.width;
                    const y = (i * 37) % 100;
                    const size = 1 + Math.sin(this.time * 0.05 + i) * 0.5;
                    ctx.globalAlpha = 0.5 + Math.sin(this.time * 0.1 + i) * 0.3;
                    ctx.beginPath();
                    ctx.arc(x, y, size, 0, Math.PI * 2);
                    ctx.fill();
                }
                ctx.globalAlpha = 1;

                // Moon
                ctx.fillStyle = '#E8E8F0';
                ctx.shadowColor = '#FFFFFF';
                ctx.shadowBlur = 30;
                ctx.beginPath();
                ctx.arc(750, 50, 30, 0, Math.PI * 2);
                ctx.fill();
                ctx.shadowBlur = 0;

                // Clouds
                ctx.fillStyle = 'rgba(100, 80, 120, 0.4)';
                this.clouds.forEach(c => {
                    ctx.beginPath();
                    ctx.arc(c.x, c.y, c.size, 0, Math.PI * 2);
                    ctx.arc(c.x + c.size * 0.6, c.y - 5, c.size * 0.7, 0, Math.PI * 2);
                    ctx.arc(c.x - c.size * 0.5, c.y + 3, c.size * 0.6, 0, Math.PI * 2);
                    ctx.fill();
                });

                // Mountains in background
                ctx.fillStyle = '#1a1a3e';
                ctx.beginPath();
                ctx.moveTo(0, 220);
                ctx.lineTo(100, 150);
                ctx.lineTo(200, 190);
                ctx.lineTo(350, 120);
                ctx.lineTo(500, 170);
                ctx.lineTo(650, 130);
                ctx.lineTo(800, 160);
                ctx.lineTo(850, 220);
                ctx.closePath();
                ctx.fill();

                // Ground
                const groundGrad = ctx.createLinearGradient(0, 220, 0, 280);
                groundGrad.addColorStop(0, '#2a4a2a');
                groundGrad.addColorStop(1, '#1a3a1a');
                ctx.fillStyle = groundGrad;
                ctx.fillRect(0, 220, this.canvas.width, 60);

                // Grass blades
                ctx.strokeStyle = '#3a5a3a';
                ctx.lineWidth = 2;
                for (let i = 0; i < this.canvas.width; i += 15) {
                    const h = 5 + Math.sin(i * 0.1 + this.time * 0.05) * 3;
                    ctx.beginPath();
                    ctx.moveTo(i, 220);
                    ctx.lineTo(i + 3, 220 - h);
                    ctx.stroke();
                }

                // Arena floor effect
                ctx.fillStyle = 'rgba(100, 80, 60, 0.3)';
                ctx.beginPath();
                ctx.ellipse(this.canvas.width / 2, 240, 300, 20, 0, 0, Math.PI * 2);
                ctx.fill();
            },

            drawShadow(x, y, size) {
                const ctx = this.ctx;
                ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
                ctx.beginPath();
                ctx.ellipse(x, y, size, size * 0.3, 0, 0, Math.PI * 2);
                ctx.fill();
            },

            drawSlash(slash) {
                const ctx = this.ctx;
                ctx.save();
                ctx.translate(slash.x, slash.y);
                ctx.rotate(slash.angle);

                const alpha = 1 - slash.progress;
                ctx.globalAlpha = alpha;

                // Slash arc
                ctx.strokeStyle = slash.color;
                ctx.lineWidth = 8 * (1 - slash.progress);
                ctx.shadowColor = slash.color;
                ctx.shadowBlur = 20;

                ctx.beginPath();
                ctx.arc(0, 0, slash.length * slash.progress, -0.5, 0.5);
                ctx.stroke();

                // Inner glow
                ctx.strokeStyle = '#FFFFFF';
                ctx.lineWidth = 3 * (1 - slash.progress);
                ctx.beginPath();
                ctx.arc(0, 0, slash.length * slash.progress, -0.3, 0.3);
                ctx.stroke();

                ctx.restore();
            },

            drawPlayerStickman(x, y) {
                const ctx = this.ctx;
                const weaponId = Player.equipment.weapon;
                const weapon = this.weaponStyles[weaponId] || this.weaponStyles['w1'];
                const isAttacking = this.playerAnim.type === 'attack' || this.playerAnim.type === 'skill';
                const isDefending = this.playerAnim.type === 'defend';
                const isHit = this.playerAnim.type === 'hit';
                const isHealing = this.playerAnim.type === 'heal';

                ctx.save();

                // Breathing animation for idle
                const breathe = this.playerAnim.type === 'idle' ? Math.sin(this.time * 0.08) * 2 : 0;

                // Healing aura
                if (isHealing) {
                    ctx.shadowColor = '#00FF00';
                    ctx.shadowBlur = 30 + Math.sin(this.time * 0.3) * 15;
                    ctx.fillStyle = 'rgba(0, 255, 100, 0.2)';
                    ctx.beginPath();
                    ctx.arc(x, y - 20, 50 + Math.sin(this.time * 0.2) * 10, 0, Math.PI * 2);
                    ctx.fill();
                }

                // Hit flash
                if (isHit && this.playerAnim.frame % 4 < 2) {
                    ctx.globalAlpha = 0.5;
                }

                // Body outline glow
                ctx.shadowColor = '#4fc3f7';
                ctx.shadowBlur = 8;

                ctx.strokeStyle = '#4fc3f7';
                ctx.lineWidth = 5;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';

                // Head with face
                ctx.beginPath();
                ctx.arc(x, y - 60 + breathe, 20, 0, Math.PI * 2);
                ctx.stroke();
                ctx.fillStyle = '#4fc3f7';
                ctx.fill();

                // Eyes
                ctx.fillStyle = '#FFFFFF';
                ctx.beginPath();
                ctx.arc(x - 6, y - 62 + breathe, 4, 0, Math.PI * 2);
                ctx.arc(x + 6, y - 62 + breathe, 4, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = '#1a1a2e';
                ctx.beginPath();
                ctx.arc(x - 5, y - 61 + breathe, 2, 0, Math.PI * 2);
                ctx.arc(x + 7, y - 61 + breathe, 2, 0, Math.PI * 2);
                ctx.fill();

                // Body
                ctx.strokeStyle = '#4fc3f7';
                ctx.lineWidth = 6;
                ctx.beginPath();
                ctx.moveTo(x, y - 40 + breathe);
                ctx.lineTo(x, y + 10);
                ctx.stroke();

                // Legs with running animation
                const legAnim = isAttacking ? Math.sin(this.playerAnim.frame * 0.5) * 0.4 :
                               (this.playerAnim.type === 'idle' ? Math.sin(this.time * 0.05) * 0.05 : 0);
                ctx.lineWidth = 5;
                ctx.beginPath();
                ctx.moveTo(x, y + 10);
                ctx.lineTo(x - 20 - legAnim * 20, y + 55);
                ctx.moveTo(x, y + 10);
                ctx.lineTo(x + 20 + legAnim * 20, y + 55);
                ctx.stroke();

                // Arms
                let armAngle = 0;
                if (isAttacking) {
                    armAngle = -Math.PI / 2 + (this.playerAnim.frame / 20) * Math.PI;
                } else if (isDefending) {
                    armAngle = -Math.PI / 3;
                } else {
                    armAngle = Math.sin(this.time * 0.05) * 0.15;
                }

                // Back arm
                ctx.beginPath();
                ctx.moveTo(x, y - 28 + breathe);
                ctx.lineTo(x - 22, y - 5);
                ctx.stroke();

                // Weapon arm
                ctx.beginPath();
                ctx.moveTo(x, y - 28 + breathe);
                const handX = x + 28 * Math.cos(armAngle);
                const handY = y - 28 + 28 * Math.sin(armAngle) + breathe;
                ctx.lineTo(handX, handY);
                ctx.stroke();

                // Draw weapon with trail
                ctx.strokeStyle = weapon.color;
                ctx.lineWidth = 6;

                if (weapon.glow) {
                    ctx.shadowColor = weapon.glow;
                    ctx.shadowBlur = 15;
                }

                const weaponLength = 50;
                const weaponAngle = armAngle + (isAttacking ? Math.PI / 4 : Math.PI / 5);
                const tipX = handX + weaponLength * Math.cos(weaponAngle);
                const tipY = handY + weaponLength * Math.sin(weaponAngle);

                // Weapon trail when attacking
                if (isAttacking && this.playerAnim.frame > 5 && this.playerAnim.frame < 20) {
                    ctx.globalAlpha = 0.5;
                    for (let i = 1; i <= 3; i++) {
                        const trailAngle = armAngle - i * 0.15 + (isAttacking ? Math.PI / 4 : Math.PI / 5);
                        const tx = handX + weaponLength * Math.cos(trailAngle);
                        const ty = handY + weaponLength * Math.sin(trailAngle);
                        ctx.globalAlpha = 0.3 - i * 0.08;
                        ctx.beginPath();
                        ctx.moveTo(handX, handY);
                        ctx.lineTo(tx, ty);
                        ctx.stroke();
                    }
                    ctx.globalAlpha = 1;
                }

                ctx.beginPath();
                ctx.moveTo(handX, handY);
                ctx.lineTo(tipX, tipY);
                ctx.stroke();

                // Weapon hilt
                ctx.strokeStyle = '#5D4037';
                ctx.lineWidth = 8;
                ctx.shadowBlur = 0;
                ctx.beginPath();
                ctx.moveTo(handX, handY);
                ctx.lineTo(handX + 8 * Math.cos(weaponAngle + Math.PI/2), handY + 8 * Math.sin(weaponAngle + Math.PI/2));
                ctx.stroke();

                // Special weapon effects
                if (weapon.name === 'fire') {
                    for (let i = 0; i < 5; i++) {
                        const t = i / 5;
                        const fx = handX + (tipX - handX) * t + (Math.random() - 0.5) * 10;
                        const fy = handY + (tipY - handY) * t + (Math.random() - 0.5) * 10 - 5;
                        const size = 4 + Math.random() * 6;
                        ctx.fillStyle = Math.random() > 0.3 ? '#FF6600' : '#FFCC00';
                        ctx.shadowColor = '#FF3300';
                        ctx.shadowBlur = 10;
                        ctx.beginPath();
                        ctx.arc(fx, fy, size, 0, Math.PI * 2);
                        ctx.fill();
                    }
                } else if (weapon.name === 'legend') {
                    // Sparkle trail
                    for (let i = 0; i < 3; i++) {
                        const t = 0.3 + i * 0.25;
                        const sx = handX + (tipX - handX) * t;
                        const sy = handY + (tipY - handY) * t;
                        ctx.fillStyle = '#FFFFFF';
                        ctx.shadowColor = '#FFD700';
                        ctx.shadowBlur = 15;
                        const sparkleSize = 4 + Math.sin(this.time * 0.3 + i) * 2;
                        ctx.beginPath();
                        ctx.arc(sx, sy, sparkleSize, 0, Math.PI * 2);
                        ctx.fill();
                    }
                } else if (weapon.name === 'silver') {
                    // Holy glow
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                    ctx.shadowColor = '#FFFFFF';
                    ctx.shadowBlur = 20;
                    ctx.beginPath();
                    ctx.arc(tipX, tipY, 8 + Math.sin(this.time * 0.2) * 3, 0, Math.PI * 2);
                    ctx.fill();
                }

                // Defense shield effect
                if (isDefending) {
                    ctx.strokeStyle = 'rgba(79, 195, 247, 0.5)';
                    ctx.lineWidth = 3;
                    ctx.shadowColor = '#4fc3f7';
                    ctx.shadowBlur = 20;
                    const shieldPulse = Math.sin(this.time * 0.2) * 5;
                    ctx.beginPath();
                    ctx.arc(x + 15, y - 20, 40 + shieldPulse, -0.8, 0.8);
                    ctx.stroke();
                }

                ctx.restore();
            },

            drawEnemyStickman(x, y) {
                const ctx = this.ctx;
                const enemyId = Battle.enemy?.id || 'e1';
                const enemyStyle = this.enemyTypes[enemyId] || this.enemyTypes['e1'];
                const isAttacking = this.enemyAnim.type === 'attack';
                const isHit = this.enemyAnim.type === 'hit';
                const isDeath = this.enemyAnim.type === 'death';
                const size = enemyStyle.size || 1;

                ctx.save();

                // Hit flash
                if (isHit && this.enemyAnim.frame % 4 < 2) {
                    ctx.globalAlpha = 0.5;
                }

                // Death effect
                if (isDeath) {
                    ctx.globalAlpha = 1 - this.enemyAnim.frame / 40;
                    y += this.enemyAnim.frame * 1.5;
                    // Red tint
                    ctx.filter = `hue-rotate(${this.enemyAnim.frame * 5}deg)`;
                }

                ctx.strokeStyle = enemyStyle.color;
                ctx.fillStyle = enemyStyle.color;
                ctx.lineWidth = 4;
                ctx.lineCap = 'round';

                // Breathing
                const breathe = !isAttacking && !isDeath ? Math.sin(this.time * 0.07) * 2 : 0;

                // Different enemy shapes
                if (enemyStyle.type === 'dragon') {
                    this.drawDragon(x, y, isAttacking, size);
                } else if (enemyStyle.type === 'skeleton') {
                    this.drawSkeleton(x, y, isAttacking, breathe);
                } else if (enemyStyle.type === 'mage') {
                    this.drawMage(x, y, isAttacking, breathe);
                } else if (enemyStyle.type === 'rat') {
                    this.drawRat(x, y, isAttacking);
                } else {
                    // Enhanced humanoid stickman
                    ctx.save();
                    ctx.translate(x, y);
                    ctx.scale(size, size);

                    // Glow for larger enemies
                    if (size > 1.2) {
                        ctx.shadowColor = enemyStyle.color;
                        ctx.shadowBlur = 10;
                    }

                    // Head
                    ctx.beginPath();
                    ctx.arc(0, -60 / size + breathe, 22, 0, Math.PI * 2);
                    ctx.stroke();
                    ctx.fill();

                    // Angry eyes
                    ctx.fillStyle = '#FF0000';
                    ctx.beginPath();
                    ctx.arc(-8, -63 / size + breathe, 5, 0, Math.PI * 2);
                    ctx.arc(8, -63 / size + breathe, 5, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.fillStyle = '#000';
                    ctx.beginPath();
                    ctx.arc(-7, -62 / size + breathe, 2, 0, Math.PI * 2);
                    ctx.arc(9, -62 / size + breathe, 2, 0, Math.PI * 2);
                    ctx.fill();

                    // Horns for minotaur/orc
                    if (enemyStyle.type === 'minotaur' || enemyStyle.type === 'orc') {
                        ctx.strokeStyle = '#5D4037';
                        ctx.lineWidth = 6;
                        ctx.beginPath();
                        ctx.moveTo(-15, -75 / size);
                        ctx.lineTo(-25, -95 / size);
                        ctx.moveTo(15, -75 / size);
                        ctx.lineTo(25, -95 / size);
                        ctx.stroke();
                    }

                    // Body
                    ctx.strokeStyle = enemyStyle.color;
                    ctx.lineWidth = 6 * (size > 1.2 ? 1.5 : 1);
                    ctx.beginPath();
                    ctx.moveTo(0, -38 / size + breathe);
                    ctx.lineTo(0, 15 / size);
                    ctx.stroke();

                    // Legs
                    ctx.lineWidth = 5;
                    const legAnim = isAttacking ? Math.sin(this.enemyAnim.frame * 0.4) * 0.3 : 0;
                    ctx.beginPath();
                    ctx.moveTo(0, 15 / size);
                    ctx.lineTo(-22 - legAnim * 15, 55 / size);
                    ctx.moveTo(0, 15 / size);
                    ctx.lineTo(22 + legAnim * 15, 55 / size);
                    ctx.stroke();

                    // Arms with weapon
                    let armAngle = isAttacking ? Math.PI / 2 - (this.enemyAnim.frame / 25) * Math.PI : Math.PI / 5;

                    ctx.beginPath();
                    ctx.moveTo(0, -23 / size);
                    ctx.lineTo(22, -3 / size);
                    ctx.stroke();

                    ctx.beginPath();
                    ctx.moveTo(0, -23 / size);
                    const handX = -28 * Math.cos(armAngle);
                    const handY = -23 / size + 28 * Math.sin(armAngle);
                    ctx.lineTo(handX, handY);
                    ctx.stroke();

                    // Weapon
                    ctx.strokeStyle = '#666666';
                    ctx.lineWidth = 8;
                    const weaponAngle = armAngle - Math.PI / 5;
                    const wepLen = 45;
                    ctx.beginPath();
                    ctx.moveTo(handX, handY);
                    ctx.lineTo(handX - wepLen * Math.cos(weaponAngle), handY + wepLen * Math.sin(weaponAngle));
                    ctx.stroke();

                    // Axe head for big enemies
                    if (size > 1.2) {
                        ctx.fillStyle = '#888888';
                        const axeX = handX - wepLen * Math.cos(weaponAngle);
                        const axeY = handY + wepLen * Math.sin(weaponAngle);
                        ctx.beginPath();
                        ctx.arc(axeX, axeY, 15, weaponAngle - 0.5, weaponAngle + 0.5);
                        ctx.lineTo(axeX - 10 * Math.cos(weaponAngle), axeY + 10 * Math.sin(weaponAngle));
                        ctx.fill();
                    }

                    ctx.restore();
                }

                ctx.restore();
            },

            drawDragon(x, y, isAttacking, size) {
                const ctx = this.ctx;
                ctx.save();

                const scale = size * 0.9;
                ctx.translate(x, y - 20);
                ctx.scale(scale, scale);

                // Dragon glow
                ctx.shadowColor = '#FF3300';
                ctx.shadowBlur = 15;

                // Body
                ctx.fillStyle = '#C62828';
                ctx.strokeStyle = '#B71C1C';
                ctx.lineWidth = 3;

                // Main body
                ctx.beginPath();
                ctx.ellipse(0, 0, 55, 35, 0, 0, Math.PI * 2);
                ctx.fill();
                ctx.stroke();

                // Scales pattern
                ctx.strokeStyle = '#8B0000';
                for (let i = -40; i < 40; i += 15) {
                    ctx.beginPath();
                    ctx.arc(i, -5, 8, 0, Math.PI);
                    ctx.stroke();
                }

                // Neck
                ctx.fillStyle = '#C62828';
                ctx.beginPath();
                ctx.moveTo(-40, -20);
                ctx.quadraticCurveTo(-60, -40, -55, -60);
                ctx.quadraticCurveTo(-50, -70, -40, -65);
                ctx.quadraticCurveTo(-35, -45, -30, -25);
                ctx.fill();

                // Head
                ctx.beginPath();
                ctx.ellipse(-55, -70, 28, 20, -0.4, 0, Math.PI * 2);
                ctx.fill();

                // Snout
                ctx.beginPath();
                ctx.moveTo(-70, -75);
                ctx.lineTo(-95, -70);
                ctx.lineTo(-70, -60);
                ctx.closePath();
                ctx.fill();

                // Eye
                ctx.fillStyle = '#FFEB3B';
                ctx.shadowColor = '#FFEB3B';
                ctx.shadowBlur = 10;
                ctx.beginPath();
                ctx.ellipse(-65, -78, 7, 5, 0, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = '#000';
                ctx.beginPath();
                ctx.ellipse(-66, -77, 3, 4, 0, 0, Math.PI * 2);
                ctx.fill();
                ctx.shadowBlur = 0;

                // Wings
                ctx.fillStyle = '#D32F2F';
                ctx.strokeStyle = '#8B0000';
                ctx.lineWidth = 2;
                const wingFlap = Math.sin(this.time * 0.15) * 15;
                ctx.beginPath();
                ctx.moveTo(0, -30);
                ctx.lineTo(50, -100 + wingFlap);
                ctx.lineTo(70, -70 + wingFlap);
                ctx.lineTo(55, -50 + wingFlap / 2);
                ctx.lineTo(30, -40);
                ctx.closePath();
                ctx.fill();
                ctx.stroke();

                // Wing bones
                ctx.strokeStyle = '#B71C1C';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(0, -30);
                ctx.lineTo(50, -100 + wingFlap);
                ctx.moveTo(15, -50);
                ctx.lineTo(55, -70 + wingFlap);
                ctx.stroke();

                // Tail
                ctx.strokeStyle = '#C62828';
                ctx.lineWidth = 12;
                ctx.beginPath();
                ctx.moveTo(50, 0);
                ctx.quadraticCurveTo(80, 20, 100, 10 + Math.sin(this.time * 0.1) * 10);
                ctx.stroke();

                // Tail spike
                ctx.fillStyle = '#8B0000';
                ctx.beginPath();
                ctx.moveTo(95, 5 + Math.sin(this.time * 0.1) * 10);
                ctx.lineTo(120, 10 + Math.sin(this.time * 0.1) * 10);
                ctx.lineTo(95, 15 + Math.sin(this.time * 0.1) * 10);
                ctx.closePath();
                ctx.fill();

                // Fire breath
                if (isAttacking) {
                    ctx.shadowColor = '#FF6600';
                    ctx.shadowBlur = 20;
                    for (let i = 0; i < 12; i++) {
                        const fx = -95 - i * 15 - Math.random() * 15;
                        const fy = -65 + (Math.random() - 0.5) * (20 + i * 3);
                        const fsize = 10 + Math.random() * 12 - i * 0.5;
                        ctx.fillStyle = i < 4 ? '#FFFFFF' : (Math.random() > 0.3 ? '#FF6600' : '#FFCC00');
                        ctx.beginPath();
                        ctx.arc(fx, fy, fsize, 0, Math.PI * 2);
                        ctx.fill();
                    }
                }

                // Legs/claws
                ctx.strokeStyle = '#8B0000';
                ctx.lineWidth = 6;
                ctx.beginPath();
                ctx.moveTo(-20, 30);
                ctx.lineTo(-25, 55);
                ctx.moveTo(20, 30);
                ctx.lineTo(25, 55);
                ctx.stroke();

                ctx.restore();
            },

            drawSkeleton(x, y, isAttacking, breathe) {
                const ctx = this.ctx;

                ctx.strokeStyle = '#ECEFF1';
                ctx.fillStyle = '#ECEFF1';
                ctx.lineWidth = 3;

                // Eerie glow
                ctx.shadowColor = '#88FFFF';
                ctx.shadowBlur = 5;

                // Skull
                ctx.beginPath();
                ctx.arc(x, y - 60 + breathe, 20, 0, Math.PI * 2);
                ctx.stroke();

                // Skull detail
                ctx.strokeStyle = '#B0BEC5';
                ctx.beginPath();
                ctx.arc(x, y - 55 + breathe, 14, 0.5, 2.6);
                ctx.stroke();

                // Eye sockets with glow
                ctx.fillStyle = '#00FFFF';
                ctx.shadowColor = '#00FFFF';
                ctx.shadowBlur = 10;
                ctx.beginPath();
                ctx.arc(x - 7, y - 63 + breathe, 5, 0, Math.PI * 2);
                ctx.arc(x + 7, y - 63 + breathe, 5, 0, Math.PI * 2);
                ctx.fill();
                ctx.shadowBlur = 0;

                // Nose hole
                ctx.fillStyle = '#37474F';
                ctx.beginPath();
                ctx.moveTo(x, y - 55 + breathe);
                ctx.lineTo(x - 3, y - 50 + breathe);
                ctx.lineTo(x + 3, y - 50 + breathe);
                ctx.closePath();
                ctx.fill();

                // Jaw with teeth
                ctx.strokeStyle = '#ECEFF1';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(x - 12, y - 48 + breathe);
                ctx.lineTo(x - 10, y - 42 + breathe);
                ctx.lineTo(x + 10, y - 42 + breathe);
                ctx.lineTo(x + 12, y - 48 + breathe);
                ctx.stroke();

                // Teeth
                for (let i = -8; i <= 8; i += 4) {
                    ctx.beginPath();
                    ctx.moveTo(x + i, y - 48 + breathe);
                    ctx.lineTo(x + i, y - 44 + breathe);
                    ctx.stroke();
                }

                // Spine
                ctx.strokeStyle = '#ECEFF1';
                ctx.lineWidth = 4;
                ctx.beginPath();
                ctx.moveTo(x, y - 40 + breathe);
                ctx.lineTo(x, y + 15);
                ctx.stroke();

                // Spine segments
                ctx.lineWidth = 2;
                for (let i = 0; i < 6; i++) {
                    const sy = y - 35 + i * 8;
                    ctx.beginPath();
                    ctx.moveTo(x - 4, sy);
                    ctx.lineTo(x + 4, sy);
                    ctx.stroke();
                }

                // Ribs
                ctx.lineWidth = 3;
                for (let i = 0; i < 4; i++) {
                    ctx.beginPath();
                    ctx.moveTo(x - 18, y - 25 + i * 10);
                    ctx.quadraticCurveTo(x, y - 20 + i * 10, x + 18, y - 25 + i * 10);
                    ctx.stroke();
                }

                // Pelvis
                ctx.beginPath();
                ctx.ellipse(x, y + 15, 15, 8, 0, 0, Math.PI);
                ctx.stroke();

                // Legs
                ctx.lineWidth = 4;
                ctx.beginPath();
                ctx.moveTo(x - 10, y + 20);
                ctx.lineTo(x - 15, y + 55);
                ctx.moveTo(x + 10, y + 20);
                ctx.lineTo(x + 15, y + 55);
                ctx.stroke();

                // Arms with sword
                const armAngle = isAttacking ? -Math.PI/3 + Math.sin(this.enemyAnim.frame * 0.3) * 0.2 : Math.PI/6;
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(x, y - 28);
                ctx.lineTo(x - 25, y - 5);
                ctx.moveTo(x, y - 28);
                ctx.lineTo(x - 22 * Math.cos(armAngle), y - 28 + 22 * Math.sin(armAngle));
                ctx.stroke();

                // Rusty sword
                ctx.strokeStyle = '#78909C';
                ctx.lineWidth = 4;
                const handX = x - 22 * Math.cos(armAngle);
                const handY = y - 28 + 22 * Math.sin(armAngle);
                ctx.beginPath();
                ctx.moveTo(handX, handY);
                ctx.lineTo(handX - 45, handY + 35);
                ctx.stroke();

                // Sword rust spots
                ctx.fillStyle = '#5D4037';
                for (let i = 0; i < 3; i++) {
                    const t = 0.3 + i * 0.2;
                    ctx.beginPath();
                    ctx.arc(handX - 45 * t, handY + 35 * t, 2, 0, Math.PI * 2);
                    ctx.fill();
                }
            },

            drawMage(x, y, isAttacking, breathe) {
                const ctx = this.ctx;

                // Magic aura
                ctx.fillStyle = 'rgba(156, 39, 176, 0.2)';
                ctx.shadowColor = '#E040FB';
                ctx.shadowBlur = 20;
                ctx.beginPath();
                ctx.arc(x, y - 20, 55 + Math.sin(this.time * 0.1) * 5, 0, Math.PI * 2);
                ctx.fill();
                ctx.shadowBlur = 0;

                // Robe
                ctx.fillStyle = '#4A148C';
                ctx.beginPath();
                ctx.moveTo(x - 30, y + 58);
                ctx.lineTo(x - 18, y - 35 + breathe);
                ctx.lineTo(x + 18, y - 35 + breathe);
                ctx.lineTo(x + 30, y + 58);
                ctx.closePath();
                ctx.fill();

                // Robe detail
                ctx.strokeStyle = '#7B1FA2';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(x, y - 30 + breathe);
                ctx.lineTo(x, y + 55);
                ctx.stroke();

                // Hood
                ctx.fillStyle = '#6A1B9A';
                ctx.beginPath();
                ctx.arc(x, y - 55 + breathe, 25, 0, Math.PI * 2);
                ctx.fill();

                // Hood shadow
                ctx.fillStyle = '#4A148C';
                ctx.beginPath();
                ctx.arc(x, y - 52 + breathe, 18, 0, Math.PI);
                ctx.fill();

                // Glowing eyes
                ctx.fillStyle = '#E040FB';
                ctx.shadowColor = '#E040FB';
                ctx.shadowBlur = 15;
                ctx.beginPath();
                ctx.arc(x - 7, y - 58 + breathe, 5, 0, Math.PI * 2);
                ctx.arc(x + 7, y - 58 + breathe, 5, 0, Math.PI * 2);
                ctx.fill();
                ctx.shadowBlur = 0;

                // Staff
                ctx.strokeStyle = '#4E342E';
                ctx.lineWidth = 6;
                ctx.beginPath();
                ctx.moveTo(x - 35, y + 55);
                ctx.lineTo(x - 25, y - 75 + breathe);
                ctx.stroke();

                // Staff crystal
                ctx.fillStyle = '#E040FB';
                ctx.shadowColor = '#E040FB';
                ctx.shadowBlur = 25 + Math.sin(this.time * 0.15) * 10;
                ctx.beginPath();
                ctx.moveTo(x - 25, y - 90 + breathe);
                ctx.lineTo(x - 35, y - 75 + breathe);
                ctx.lineTo(x - 25, y - 70 + breathe);
                ctx.lineTo(x - 15, y - 75 + breathe);
                ctx.closePath();
                ctx.fill();

                // Crystal inner glow
                ctx.fillStyle = '#FFFFFF';
                ctx.beginPath();
                ctx.arc(x - 25, y - 78 + breathe, 4, 0, Math.PI * 2);
                ctx.fill();
                ctx.shadowBlur = 0;

                // Magic attack
                if (isAttacking) {
                    // Magic circle
                    ctx.strokeStyle = '#E040FB';
                    ctx.lineWidth = 2;
                    ctx.shadowColor = '#E040FB';
                    ctx.shadowBlur = 15;
                    const circleX = x - 80 - this.enemyAnim.frame * 5;
                    ctx.beginPath();
                    ctx.arc(circleX, y - 40, 20, 0, Math.PI * 2);
                    ctx.stroke();

                    // Runes
                    for (let i = 0; i < 6; i++) {
                        const angle = (i / 6) * Math.PI * 2 + this.time * 0.1;
                        const rx = circleX + Math.cos(angle) * 15;
                        const ry = y - 40 + Math.sin(angle) * 15;
                        ctx.fillStyle = '#E040FB';
                        ctx.beginPath();
                        ctx.arc(rx, ry, 3, 0, Math.PI * 2);
                        ctx.fill();
                    }

                    // Energy bolts
                    for (let i = 0; i < 5; i++) {
                        const bx = x - 50 - i * 25 - Math.random() * 10;
                        const by = y - 40 + Math.sin(this.time * 0.2 + i) * 25;
                        ctx.fillStyle = `rgba(224, 64, 251, ${0.9 - i * 0.15})`;
                        ctx.beginPath();
                        ctx.arc(bx, by, 12 - i, 0, Math.PI * 2);
                        ctx.fill();
                    }
                }

                // Floating particles
                for (let i = 0; i < 3; i++) {
                    const angle = (i / 3) * Math.PI * 2 + this.time * 0.03;
                    const dist = 35 + Math.sin(this.time * 0.05 + i) * 5;
                    const px = x + Math.cos(angle) * dist;
                    const py = y - 20 + Math.sin(angle) * dist * 0.5;
                    ctx.fillStyle = 'rgba(224, 64, 251, 0.6)';
                    ctx.shadowColor = '#E040FB';
                    ctx.shadowBlur = 10;
                    ctx.beginPath();
                    ctx.arc(px, py, 4, 0, Math.PI * 2);
                    ctx.fill();
                }
                ctx.shadowBlur = 0;
            },

            drawRat(x, y, isAttacking) {
                const ctx = this.ctx;

                ctx.fillStyle = '#5D4037';
                ctx.strokeStyle = '#3E2723';
                ctx.lineWidth = 2;

                // Body
                ctx.beginPath();
                ctx.ellipse(x, y + 20, 30, 18, 0, 0, Math.PI * 2);
                ctx.fill();
                ctx.stroke();

                // Head
                ctx.beginPath();
                ctx.ellipse(x - 25, y + 10, 18, 14, -0.3, 0, Math.PI * 2);
                ctx.fill();
                ctx.stroke();

                // Snout
                ctx.beginPath();
                ctx.ellipse(x - 45, y + 8, 10, 7, -0.2, 0, Math.PI * 2);
                ctx.fill();

                // Nose
                ctx.fillStyle = '#FF8A80';
                ctx.beginPath();
                ctx.arc(x - 55, y + 6, 4, 0, Math.PI * 2);
                ctx.fill();

                // Eyes
                ctx.fillStyle = '#FF0000';
                ctx.shadowColor = '#FF0000';
                ctx.shadowBlur = 5;
                ctx.beginPath();
                ctx.arc(x - 35, y + 3, 4, 0, Math.PI * 2);
                ctx.fill();
                ctx.shadowBlur = 0;

                // Ears
                ctx.fillStyle = '#8D6E63';
                ctx.beginPath();
                ctx.ellipse(x - 20, y - 5, 8, 12, -0.5, 0, Math.PI * 2);
                ctx.ellipse(x - 30, y - 3, 8, 12, -0.8, 0, Math.PI * 2);
                ctx.fill();

                // Whiskers
                ctx.strokeStyle = '#BCAAA4';
                ctx.lineWidth = 1;
                for (let i = 0; i < 3; i++) {
                    ctx.beginPath();
                    ctx.moveTo(x - 50, y + 5 + i * 4);
                    ctx.lineTo(x - 70, y + 2 + i * 5);
                    ctx.stroke();
                }

                // Tail
                ctx.strokeStyle = '#8D6E63';
                ctx.lineWidth = 4;
                ctx.beginPath();
                ctx.moveTo(x + 28, y + 25);
                ctx.quadraticCurveTo(x + 60, y + 40, x + 70, y + 20 + Math.sin(this.time * 0.2) * 10);
                ctx.stroke();

                // Legs
                ctx.strokeStyle = '#5D4037';
                ctx.lineWidth = 4;
                ctx.beginPath();
                ctx.moveTo(x - 15, y + 35);
                ctx.lineTo(x - 20, y + 55);
                ctx.moveTo(x + 10, y + 35);
                ctx.lineTo(x + 15, y + 55);
                ctx.stroke();

                // Attack - lunge forward
                if (isAttacking) {
                    // Teeth
                    ctx.fillStyle = '#FFFFFF';
                    ctx.beginPath();
                    ctx.moveTo(x - 48, y + 12);
                    ctx.lineTo(x - 52, y + 20);
                    ctx.lineTo(x - 44, y + 12);
                    ctx.fill();
                    ctx.beginPath();
                    ctx.moveTo(x - 42, y + 12);
                    ctx.lineTo(x - 46, y + 18);
                    ctx.lineTo(x - 38, y + 12);
                    ctx.fill();
                }
            },

            // Animation triggers with effects
            playPlayerAttack() {
                this.playerAnim = { type: 'attack', frame: 0, duration: 30 };
                this.combo++;
                this.comboTimer = 120;
            },

            playPlayerSkill() {
                this.playerAnim = { type: 'skill', frame: 0, duration: 40 };
                this.combo += 2;
                this.comboTimer = 120;
            },

            playPlayerDefend() {
                this.playerAnim = { type: 'defend', frame: 0, duration: 30 };
            },

            playPlayerHit() {
                this.playerAnim = { type: 'hit', frame: 0, duration: 20 };
                this.combo = 0;
            },

            playPlayerHeal() {
                this.playerAnim = { type: 'heal', frame: 0, duration: 40 };
            },

            playEnemyAttack() {
                this.enemyAnim = { type: 'attack', frame: 0, duration: 30 };
            },

            playEnemyHit() {
                this.enemyAnim = { type: 'hit', frame: 0, duration: 20 };
            },

            playEnemyDeath() {
                this.enemyAnim = { type: 'death', frame: 0, duration: 40 };
                this.spawnSparks(this.enemy.baseX, 120, 30, '#FF0000');
                this.triggerShake(20);
            },

            showDamage(x, y, text, color, size = 24) {
                this.popups.push({
                    x: x + (Math.random() - 0.5) * 30,
                    y: y,
                    text: text,
                    color: color,
                    alpha: 1,
                    size: size,
                    scale: 0.5
                });
            }
        };

        // ===================== UTILITY FUNCTIONS =====================
        function notify(message, type = 'info') {
            const notif = document.createElement('div');
            notif.className = `notification ${type}`;
            notif.textContent = message;
            document.body.appendChild(notif);
            setTimeout(() => notif.remove(), 3000);
        }

        function saveGame() {
            localStorage.setItem('questRpgSave', JSON.stringify({
                player: Player,
                quests: GameData.quests
            }));
        }

        function loadGame() {
            const save = localStorage.getItem('questRpgSave');
            if (save) {
                const data = JSON.parse(save);
                Player = data.player;
                GameData.quests = data.quests;
                updateOwnedItems();
            }
        }

        function updateOwnedItems() {
            GameData.weapons.forEach(w => w.owned = Player.ownedItems.includes(w.id));
            GameData.armor.forEach(a => a.owned = Player.ownedItems.includes(a.id));
        }

        // ===================== UI UPDATES =====================
        function updateHeader() {
            document.getElementById('player-name').textContent = Player.name;
            document.getElementById('header-level').textContent = Player.level;
            document.getElementById('header-gold').textContent = Player.gold;

            const hpPercent = (Player.hp / Player.maxHp) * 100;
            document.getElementById('header-hp-fill').style.width = hpPercent + '%';
            document.getElementById('header-hp-text').textContent = `${Player.hp}/${Player.maxHp}`;

            const mpPercent = (Player.mp / Player.maxMp) * 100;
            document.getElementById('header-mp-fill').style.width = mpPercent + '%';
            document.getElementById('header-mp-text').textContent = `${Player.mp}/${Player.maxMp}`;

            const xpPercent = (Player.xp / Player.xpToNext) * 100;
            document.getElementById('xp-fill').style.width = xpPercent + '%';
            document.getElementById('xp-text').textContent = `${Player.xp} / ${Player.xpToNext} XP`;
        }

        function getPlayerAttack() {
            const weapon = GameData.weapons.find(w => w.id === Player.equipment.weapon);
            return Player.stats.strength * 2 + (weapon ? weapon.attack : 0);
        }

        function getPlayerDefense() {
            const armor = GameData.armor.find(a => a.id === Player.equipment.armor);
            return Player.stats.agility + (armor ? armor.defense : 0);
        }

        function getCritChance() {
            return Math.min(50, 5 + Player.stats.agility);
        }

        // ===================== NAVIGATION =====================
        document.querySelectorAll('.nav-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                if (Battle.active) {
                    notify('–°–Ω–∞—á–∞–ª–∞ –∑–∞–∫–æ–Ω—á–∏ –±–æ–π!', 'error');
                    return;
                }

                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                const screenId = btn.dataset.screen + '-screen';
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById(screenId).classList.add('active');

                if (btn.dataset.screen === 'shop') renderShop('weapons');
                if (btn.dataset.screen === 'character') renderCharacter();
                if (btn.dataset.screen === 'arena') renderArena();
                if (btn.dataset.screen === 'castle') renderQuests();
            });
        });

        // ===================== PORTRAIT DRAWING SYSTEM =====================
        const Portraits = {
            // Draw king portrait
            drawKing(canvas) {
                const ctx = canvas.getContext('2d');
                const w = canvas.width;
                const h = canvas.height;
                ctx.clearRect(0, 0, w, h);

                // Background gradient
                const bg = ctx.createRadialGradient(w/2, h/2, 0, w/2, h/2, w/2);
                bg.addColorStop(0, '#2a2040');
                bg.addColorStop(1, '#1a1030');
                ctx.fillStyle = bg;
                ctx.fillRect(0, 0, w, h);

                // Body - royal robe
                ctx.fillStyle = '#8B0000';
                ctx.beginPath();
                ctx.moveTo(w*0.25, h);
                ctx.quadraticCurveTo(w*0.3, h*0.7, w*0.35, h*0.55);
                ctx.lineTo(w*0.65, h*0.55);
                ctx.quadraticCurveTo(w*0.7, h*0.7, w*0.75, h);
                ctx.fill();

                // Gold trim on robe
                ctx.strokeStyle = '#FFD700';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(w*0.35, h*0.55);
                ctx.lineTo(w*0.35, h*0.9);
                ctx.moveTo(w*0.65, h*0.55);
                ctx.lineTo(w*0.65, h*0.9);
                ctx.stroke();

                // Fur collar
                ctx.fillStyle = '#F5F5DC';
                ctx.beginPath();
                ctx.ellipse(w*0.5, h*0.52, w*0.18, h*0.06, 0, 0, Math.PI * 2);
                ctx.fill();

                // Neck
                ctx.fillStyle = '#DEB887';
                ctx.fillRect(w*0.42, h*0.38, w*0.16, h*0.15);

                // Head
                const headGrad = ctx.createRadialGradient(w*0.45, h*0.25, 0, w*0.5, h*0.28, w*0.15);
                headGrad.addColorStop(0, '#FFDAB9');
                headGrad.addColorStop(1, '#DEB887');
                ctx.fillStyle = headGrad;
                ctx.beginPath();
                ctx.ellipse(w*0.5, h*0.28, w*0.15, h*0.13, 0, 0, Math.PI * 2);
                ctx.fill();

                // Crown
                const crownGrad = ctx.createLinearGradient(w*0.32, h*0.1, w*0.68, h*0.1);
                crownGrad.addColorStop(0, '#DAA520');
                crownGrad.addColorStop(0.5, '#FFD700');
                crownGrad.addColorStop(1, '#DAA520');
                ctx.fillStyle = crownGrad;

                // Crown base
                ctx.fillRect(w*0.32, h*0.15, w*0.36, h*0.06);

                // Crown points
                ctx.beginPath();
                ctx.moveTo(w*0.32, h*0.15);
                ctx.lineTo(w*0.35, h*0.06);
                ctx.lineTo(w*0.42, h*0.12);
                ctx.lineTo(w*0.5, h*0.04);
                ctx.lineTo(w*0.58, h*0.12);
                ctx.lineTo(w*0.65, h*0.06);
                ctx.lineTo(w*0.68, h*0.15);
                ctx.closePath();
                ctx.fill();

                // Jewels on crown
                ctx.fillStyle = '#FF0000';
                ctx.beginPath();
                ctx.arc(w*0.5, h*0.08, w*0.03, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = '#0000FF';
                ctx.beginPath();
                ctx.arc(w*0.38, h*0.12, w*0.02, 0, Math.PI * 2);
                ctx.arc(w*0.62, h*0.12, w*0.02, 0, Math.PI * 2);
                ctx.fill();

                // Eyes
                ctx.fillStyle = '#FFF';
                ctx.beginPath();
                ctx.ellipse(w*0.43, h*0.26, w*0.035, h*0.025, 0, 0, Math.PI * 2);
                ctx.ellipse(w*0.57, h*0.26, w*0.035, h*0.025, 0, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = '#4169E1';
                ctx.beginPath();
                ctx.arc(w*0.43, h*0.26, w*0.02, 0, Math.PI * 2);
                ctx.arc(w*0.57, h*0.26, w*0.02, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = '#000';
                ctx.beginPath();
                ctx.arc(w*0.43, h*0.26, w*0.01, 0, Math.PI * 2);
                ctx.arc(w*0.57, h*0.26, w*0.01, 0, Math.PI * 2);
                ctx.fill();

                // Eyebrows
                ctx.strokeStyle = '#8B4513';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(w*0.38, h*0.23);
                ctx.quadraticCurveTo(w*0.43, h*0.21, w*0.48, h*0.23);
                ctx.moveTo(w*0.52, h*0.23);
                ctx.quadraticCurveTo(w*0.57, h*0.21, w*0.62, h*0.23);
                ctx.stroke();

                // Nose
                ctx.strokeStyle = '#C9A77C';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.moveTo(w*0.5, h*0.27);
                ctx.lineTo(w*0.48, h*0.32);
                ctx.lineTo(w*0.5, h*0.33);
                ctx.stroke();

                // Beard
                ctx.fillStyle = '#C0C0C0';
                ctx.beginPath();
                ctx.moveTo(w*0.38, h*0.35);
                ctx.quadraticCurveTo(w*0.35, h*0.45, w*0.4, h*0.52);
                ctx.quadraticCurveTo(w*0.5, h*0.58, w*0.6, h*0.52);
                ctx.quadraticCurveTo(w*0.65, h*0.45, w*0.62, h*0.35);
                ctx.fill();

                // Mustache
                ctx.beginPath();
                ctx.moveTo(w*0.42, h*0.36);
                ctx.quadraticCurveTo(w*0.35, h*0.38, w*0.32, h*0.42);
                ctx.quadraticCurveTo(w*0.38, h*0.40, w*0.48, h*0.37);
                ctx.fill();
                ctx.beginPath();
                ctx.moveTo(w*0.58, h*0.36);
                ctx.quadraticCurveTo(w*0.65, h*0.38, w*0.68, h*0.42);
                ctx.quadraticCurveTo(w*0.62, h*0.40, w*0.52, h*0.37);
                ctx.fill();

                // Mouth hint
                ctx.strokeStyle = '#8B4513';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(w*0.45, h*0.37);
                ctx.quadraticCurveTo(w*0.5, h*0.39, w*0.55, h*0.37);
                ctx.stroke();

                // Scepter
                ctx.fillStyle = '#DAA520';
                ctx.fillRect(w*0.72, h*0.4, w*0.04, h*0.55);
                ctx.fillStyle = '#FFD700';
                ctx.beginPath();
                ctx.arc(w*0.74, h*0.38, w*0.06, 0, Math.PI * 2);
                ctx.fill();
                ctx.fillStyle = '#FF0000';
                ctx.beginPath();
                ctx.arc(w*0.74, h*0.38, w*0.03, 0, Math.PI * 2);
                ctx.fill();
            },

            // Draw enemy portrait on canvas
            drawEnemy(canvas, enemyId) {
                const ctx = canvas.getContext('2d');
                const w = canvas.width;
                const h = canvas.height;
                ctx.clearRect(0, 0, w, h);

                const enemy = GameData.enemies.find(e => e.id === enemyId);
                if (!enemy) return;

                // Background based on enemy type
                const colors = {
                    'e1': ['#2d4a2d', '#1a2d1a'], // Goblin - green
                    'e2': ['#3d3d3d', '#1a1a1a'], // Rat - gray
                    'e9': ['#2d3d4a', '#1a2a3a'], // Wolf - blue-gray
                    'e3': ['#4a4a5a', '#2a2a3a'], // Skeleton - purple-gray
                    'e10': ['#3a4a5a', '#1a2a3a'], // Ghost - pale blue
                    'e4': ['#4a3d2d', '#2d2a1a'], // Orc - brown-green
                    'e11': ['#3a2a3a', '#1a1a2a'], // Spider - dark purple
                    'e5': ['#4a5a4a', '#2a3a2a'], // Troll - moss green
                    'e12': ['#3a4a3a', '#1a2a1a'], // Medusa - swamp green
                    'e6': ['#4a2a5a', '#2a1a3a'], // Mage - purple
                    'e7': ['#5a4a3a', '#3a2a1a'], // Minotaur - brown
                    'e13': ['#5a2a2a', '#3a1a1a'], // Demon - dark red
                    'e8': ['#5a3a2a', '#3a1a0a'], // Dragon - orange-red
                    'e14': ['#3a3a4a', '#1a1a2a'], // Lich - cold blue
                    'e15': ['#2a1a3a', '#0a0a1a'], // Dark Lord - black-purple
                };

                const [c1, c2] = colors[enemyId] || ['#3a3a3a', '#1a1a1a'];
                const bg = ctx.createRadialGradient(w/2, h/2, 0, w/2, h/2, w*0.7);
                bg.addColorStop(0, c1);
                bg.addColorStop(1, c2);
                ctx.fillStyle = bg;
                ctx.beginPath();
                ctx.arc(w/2, h/2, w*0.48, 0, Math.PI * 2);
                ctx.fill();

                // Draw based on enemy type
                this.drawEnemyType(ctx, w, h, enemyId);

                // Border glow for bosses
                if (enemy.boss) {
                    ctx.strokeStyle = '#9b59b6';
                    ctx.lineWidth = 3;
                    ctx.shadowColor = '#9b59b6';
                    ctx.shadowBlur = 10;
                    ctx.beginPath();
                    ctx.arc(w/2, h/2, w*0.46, 0, Math.PI * 2);
                    ctx.stroke();
                    ctx.shadowBlur = 0;
                }
            },

            drawEnemyType(ctx, w, h, enemyId) {
                const cx = w/2, cy = h/2;

                switch(enemyId) {
                    case 'e1': // Goblin
                        // Green skin face
                        ctx.fillStyle = '#4CAF50';
                        ctx.beginPath();
                        ctx.ellipse(cx, cy, w*0.3, h*0.35, 0, 0, Math.PI*2);
                        ctx.fill();
                        // Pointy ears
                        ctx.beginPath();
                        ctx.moveTo(cx - w*0.25, cy - h*0.1);
                        ctx.lineTo(cx - w*0.4, cy - h*0.3);
                        ctx.lineTo(cx - w*0.2, cy - h*0.2);
                        ctx.fill();
                        ctx.beginPath();
                        ctx.moveTo(cx + w*0.25, cy - h*0.1);
                        ctx.lineTo(cx + w*0.4, cy - h*0.3);
                        ctx.lineTo(cx + w*0.2, cy - h*0.2);
                        ctx.fill();
                        // Evil eyes
                        ctx.fillStyle = '#FF0';
                        ctx.beginPath();
                        ctx.ellipse(cx - w*0.1, cy - h*0.05, w*0.08, h*0.06, 0, 0, Math.PI*2);
                        ctx.ellipse(cx + w*0.1, cy - h*0.05, w*0.08, h*0.06, 0, 0, Math.PI*2);
                        ctx.fill();
                        ctx.fillStyle = '#000';
                        ctx.beginPath();
                        ctx.arc(cx - w*0.1, cy - h*0.05, w*0.03, 0, Math.PI*2);
                        ctx.arc(cx + w*0.1, cy - h*0.05, w*0.03, 0, Math.PI*2);
                        ctx.fill();
                        // Evil grin
                        ctx.strokeStyle = '#2E7D32';
                        ctx.lineWidth = 2;
                        ctx.beginPath();
                        ctx.arc(cx, cy + h*0.15, w*0.15, 0.2, Math.PI - 0.2);
                        ctx.stroke();
                        break;

                    case 'e2': // Rat
                        // Body
                        ctx.fillStyle = '#795548';
                        ctx.beginPath();
                        ctx.ellipse(cx, cy, w*0.25, h*0.2, 0, 0, Math.PI*2);
                        ctx.fill();
                        // Ears
                        ctx.fillStyle = '#F8BBD9';
                        ctx.beginPath();
                        ctx.ellipse(cx - w*0.15, cy - h*0.2, w*0.1, h*0.12, -0.3, 0, Math.PI*2);
                        ctx.ellipse(cx + w*0.15, cy - h*0.2, w*0.1, h*0.12, 0.3, 0, Math.PI*2);
                        ctx.fill();
                        // Snout
                        ctx.fillStyle = '#8D6E63';
                        ctx.beginPath();
                        ctx.ellipse(cx, cy + h*0.1, w*0.12, h*0.1, 0, 0, Math.PI*2);
                        ctx.fill();
                        // Nose
                        ctx.fillStyle = '#F8BBD9';
                        ctx.beginPath();
                        ctx.arc(cx, cy + h*0.15, w*0.05, 0, Math.PI*2);
                        ctx.fill();
                        // Red eyes
                        ctx.fillStyle = '#F00';
                        ctx.beginPath();
                        ctx.arc(cx - w*0.08, cy - h*0.05, w*0.04, 0, Math.PI*2);
                        ctx.arc(cx + w*0.08, cy - h*0.05, w*0.04, 0, Math.PI*2);
                        ctx.fill();
                        // Whiskers
                        ctx.strokeStyle = '#333';
                        ctx.lineWidth = 1;
                        for (let i = -1; i <= 1; i += 2) {
                            ctx.beginPath();
                            ctx.moveTo(cx + i*w*0.05, cy + h*0.1);
                            ctx.lineTo(cx + i*w*0.35, cy + h*0.05);
                            ctx.moveTo(cx + i*w*0.05, cy + h*0.12);
                            ctx.lineTo(cx + i*w*0.35, cy + h*0.15);
                            ctx.stroke();
                        }
                        break;

                    case 'e3': // Skeleton
                        // Skull
                        ctx.fillStyle = '#ECEFF1';
                        ctx.beginPath();
                        ctx.ellipse(cx, cy - h*0.05, w*0.25, h*0.3, 0, 0, Math.PI*2);
                        ctx.fill();
                        // Eye sockets
                        ctx.fillStyle = '#000';
                        ctx.beginPath();
                        ctx.ellipse(cx - w*0.1, cy - h*0.1, w*0.08, h*0.1, 0, 0, Math.PI*2);
                        ctx.ellipse(cx + w*0.1, cy - h*0.1, w*0.08, h*0.1, 0, 0, Math.PI*2);
                        ctx.fill();
                        // Red glowing eyes
                        ctx.fillStyle = '#F00';
                        ctx.shadowColor = '#F00';
                        ctx.shadowBlur = 5;
                        ctx.beginPath();
                        ctx.arc(cx - w*0.1, cy - h*0.1, w*0.03, 0, Math.PI*2);
                        ctx.arc(cx + w*0.1, cy - h*0.1, w*0.03, 0, Math.PI*2);
                        ctx.fill();
                        ctx.shadowBlur = 0;
                        // Nose hole
                        ctx.fillStyle = '#000';
                        ctx.beginPath();
                        ctx.moveTo(cx, cy + h*0.02);
                        ctx.lineTo(cx - w*0.04, cy + h*0.1);
                        ctx.lineTo(cx + w*0.04, cy + h*0.1);
                        ctx.fill();
                        // Teeth
                        ctx.fillStyle = '#ECEFF1';
                        ctx.strokeStyle = '#666';
                        for (let i = 0; i < 6; i++) {
                            ctx.fillRect(cx - w*0.15 + i*w*0.05, cy + h*0.15, w*0.04, h*0.1);
                            ctx.strokeRect(cx - w*0.15 + i*w*0.05, cy + h*0.15, w*0.04, h*0.1);
                        }
                        break;

                    case 'e4': // Orc
                        // Green face
                        ctx.fillStyle = '#558B2F';
                        ctx.beginPath();
                        ctx.ellipse(cx, cy, w*0.32, h*0.38, 0, 0, Math.PI*2);
                        ctx.fill();
                        // Brow ridge
                        ctx.fillStyle = '#33691E';
                        ctx.beginPath();
                        ctx.ellipse(cx, cy - h*0.2, w*0.28, h*0.08, 0, 0, Math.PI);
                        ctx.fill();
                        // Angry eyes
                        ctx.fillStyle = '#FF0';
                        ctx.beginPath();
                        ctx.ellipse(cx - w*0.12, cy - h*0.08, w*0.06, h*0.05, -0.3, 0, Math.PI*2);
                        ctx.ellipse(cx + w*0.12, cy - h*0.08, w*0.06, h*0.05, 0.3, 0, Math.PI*2);
                        ctx.fill();
                        ctx.fillStyle = '#000';
                        ctx.beginPath();
                        ctx.arc(cx - w*0.12, cy - h*0.08, w*0.025, 0, Math.PI*2);
                        ctx.arc(cx + w*0.12, cy - h*0.08, w*0.025, 0, Math.PI*2);
                        ctx.fill();
                        // Big nose
                        ctx.fillStyle = '#689F38';
                        ctx.beginPath();
                        ctx.ellipse(cx, cy + h*0.05, w*0.08, h*0.08, 0, 0, Math.PI*2);
                        ctx.fill();
                        // Tusks
                        ctx.fillStyle = '#F5F5DC';
                        ctx.beginPath();
                        ctx.moveTo(cx - w*0.15, cy + h*0.2);
                        ctx.lineTo(cx - w*0.1, cy + h*0.05);
                        ctx.lineTo(cx - w*0.08, cy + h*0.2);
                        ctx.fill();
                        ctx.beginPath();
                        ctx.moveTo(cx + w*0.15, cy + h*0.2);
                        ctx.lineTo(cx + w*0.1, cy + h*0.05);
                        ctx.lineTo(cx + w*0.08, cy + h*0.2);
                        ctx.fill();
                        break;

                    case 'e8': // Dragon
                        // Dragon head
                        ctx.fillStyle = '#C62828';
                        ctx.beginPath();
                        ctx.moveTo(cx, cy - h*0.35);
                        ctx.quadraticCurveTo(cx + w*0.35, cy - h*0.2, cx + w*0.25, cy + h*0.1);
                        ctx.quadraticCurveTo(cx + w*0.15, cy + h*0.35, cx, cy + h*0.3);
                        ctx.quadraticCurveTo(cx - w*0.15, cy + h*0.35, cx - w*0.25, cy + h*0.1);
                        ctx.quadraticCurveTo(cx - w*0.35, cy - h*0.2, cx, cy - h*0.35);
                        ctx.fill();
                        // Horns
                        ctx.fillStyle = '#5D4037';
                        ctx.beginPath();
                        ctx.moveTo(cx - w*0.15, cy - h*0.25);
                        ctx.lineTo(cx - w*0.3, cy - h*0.45);
                        ctx.lineTo(cx - w*0.1, cy - h*0.2);
                        ctx.fill();
                        ctx.beginPath();
                        ctx.moveTo(cx + w*0.15, cy - h*0.25);
                        ctx.lineTo(cx + w*0.3, cy - h*0.45);
                        ctx.lineTo(cx + w*0.1, cy - h*0.2);
                        ctx.fill();
                        // Eyes
                        ctx.fillStyle = '#FF0';
                        ctx.shadowColor = '#FF0';
                        ctx.shadowBlur = 8;
                        ctx.beginPath();
                        ctx.ellipse(cx - w*0.1, cy - h*0.1, w*0.06, h*0.08, 0, 0, Math.PI*2);
                        ctx.ellipse(cx + w*0.1, cy - h*0.1, w*0.06, h*0.08, 0, 0, Math.PI*2);
                        ctx.fill();
                        ctx.shadowBlur = 0;
                        ctx.fillStyle = '#000';
                        ctx.beginPath();
                        ctx.ellipse(cx - w*0.1, cy - h*0.1, w*0.02, h*0.06, 0, 0, Math.PI*2);
                        ctx.ellipse(cx + w*0.1, cy - h*0.1, w*0.02, h*0.06, 0, 0, Math.PI*2);
                        ctx.fill();
                        // Nostrils
                        ctx.fillStyle = '#000';
                        ctx.beginPath();
                        ctx.ellipse(cx - w*0.04, cy + h*0.1, w*0.02, h*0.025, 0, 0, Math.PI*2);
                        ctx.ellipse(cx + w*0.04, cy + h*0.1, w*0.02, h*0.025, 0, 0, Math.PI*2);
                        ctx.fill();
                        // Fire from nostrils
                        ctx.fillStyle = '#FF6600';
                        ctx.beginPath();
                        ctx.moveTo(cx - w*0.04, cy + h*0.12);
                        ctx.quadraticCurveTo(cx - w*0.08, cy + h*0.25, cx - w*0.02, cy + h*0.35);
                        ctx.quadraticCurveTo(cx - w*0.06, cy + h*0.25, cx - w*0.04, cy + h*0.12);
                        ctx.fill();
                        ctx.beginPath();
                        ctx.moveTo(cx + w*0.04, cy + h*0.12);
                        ctx.quadraticCurveTo(cx + w*0.08, cy + h*0.25, cx + w*0.02, cy + h*0.35);
                        ctx.quadraticCurveTo(cx + w*0.06, cy + h*0.25, cx + w*0.04, cy + h*0.12);
                        ctx.fill();
                        // Scales pattern
                        ctx.strokeStyle = '#8B0000';
                        ctx.lineWidth = 1;
                        for (let i = 0; i < 4; i++) {
                            ctx.beginPath();
                            ctx.arc(cx, cy - h*0.25 + i*h*0.12, w*0.2 - i*w*0.03, 0.8, Math.PI - 0.8);
                            ctx.stroke();
                        }
                        break;

                    default: // Generic monster
                        ctx.font = `${w*0.5}px Arial`;
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        const enemy = GameData.enemies.find(e => e.id === enemyId);
                        ctx.fillText(enemy?.icon || 'üëπ', cx, cy);
                }
            }
        };

        // ===================== CASTLE / QUESTS =====================
        function renderQuests() {
            // Draw king portrait
            const kingCanvas = document.getElementById('king-canvas');
            if (kingCanvas) Portraits.drawKing(kingCanvas);

            // Update king speech based on completed quests
            const completedCount = GameData.quests.filter(q => q.completed).length;
            const speeches = [
                "–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤—É—é —Ç–µ–±—è, –≤–æ–∏–Ω! –ù–∞—à–µ –∫–æ—Ä–æ–ª–µ–≤—Å—Ç–≤–æ –Ω—É–∂–¥–∞–µ—Ç—Å—è –≤ —Ç–≤–æ–µ–π –ø–æ–º–æ—â–∏. –í—ã–±–µ—Ä–∏ –∑–∞–¥–∞–Ω–∏–µ –∏ –¥–æ–∫–∞–∂–∏ —Å–≤–æ—é –¥–æ–±–ª–µ—Å—Ç—å!",
                "–¢—ã –¥–µ–ª–∞–µ—à—å —É—Å–ø–µ—Ö–∏, –≥–µ—Ä–æ–π! –ü—Ä–æ–¥–æ–ª–∂–∞–π –æ—á–∏—â–∞—Ç—å –∑–µ–º–ª–∏ –æ—Ç –º–æ–Ω—Å—Ç—Ä–æ–≤!",
                "–¢–≤–æ—è —Å–ª–∞–≤–∞ —Ä–∞—Å—Ç—ë—Ç! –í—Ä–∞–≥–∏ –Ω–∞—á–∏–Ω–∞—é—Ç –±–æ—è—Ç—å—Å—è —Ç–≤–æ–µ–≥–æ –∏–º–µ–Ω–∏!",
                "–í–µ–ª–∏–∫–∏–π –≤–æ–∏–Ω! –¢—ã —É–∂–µ –ø–æ–±–µ–¥–∏–ª –º–Ω–æ–≥–∏—Ö –≤—Ä–∞–≥–æ–≤. –û—Å—Ç–∞–ª–æ—Å—å —Å—Ä–∞–∑–∏—Ç—å —Å–∞–º—ã—Ö –º–æ–≥—É—á–∏—Ö!",
                "–õ–µ–≥–µ–Ω–¥–∞—Ä–Ω—ã–π –≥–µ—Ä–æ–π! –¢—ë–º–Ω—ã–µ —Å–∏–ª—ã —Ç—Ä–µ–ø–µ—â—É—Ç –ø–µ—Ä–µ–¥ —Ç–æ–±–æ–π!"
            ];
            const speechIndex = Math.min(Math.floor(completedCount / 3), speeches.length - 1);
            document.getElementById('king-speech').textContent = speeches[speechIndex];

            const container = document.getElementById('quest-list');
            container.innerHTML = '';

            GameData.quests.forEach(quest => {
                const enemy = GameData.enemies.find(e => e.id === quest.target.enemy);
                const enemyName = enemy?.name || '–≤—Ä–∞–≥–∞';
                const progress = Math.min(quest.progress, quest.target.count);
                const progressPercent = (progress / quest.target.count) * 100;

                const div = document.createElement('div');
                div.className = 'quest-item' + (quest.completed ? ' completed' : '');

                // Create quest card with portrait
                const canvasId = `quest-enemy-${quest.id}`;
                div.innerHTML = `
                    <div class="quest-header">
                        <canvas class="quest-enemy-portrait" id="${canvasId}" width="60" height="60"></canvas>
                        <div class="quest-info">
                            <div class="quest-title">${quest.completed ? '‚úÖ ' : ''}${quest.title}</div>
                            <div class="quest-target">üéØ ${enemyName} √ó ${quest.target.count}</div>
                        </div>
                    </div>
                    <div class="quest-body">
                        <div class="quest-desc">${quest.desc}</div>
                        <div class="quest-progress">
                            <div class="quest-progress-fill" style="width: ${quest.completed ? 100 : progressPercent}%"></div>
                        </div>
                        <div class="quest-reward">
                            <span class="reward-item reward-gold">üí∞ ${quest.reward.gold}</span>
                            <span class="reward-item reward-xp">‚≠ê ${quest.reward.xp} XP</span>
                        </div>
                    </div>
                `;

                if (!quest.completed && quest.progress >= quest.target.count) {
                    const body = div.querySelector('.quest-body');
                    const claimBtn = document.createElement('button');
                    claimBtn.className = 'buy-btn';
                    claimBtn.style.width = '100%';
                    claimBtn.style.marginTop = '10px';
                    claimBtn.textContent = 'üéÅ –ó–∞–±—Ä–∞—Ç—å –Ω–∞–≥—Ä–∞–¥—É!';
                    claimBtn.onclick = (e) => { e.stopPropagation(); claimQuest(quest); };
                    body.appendChild(claimBtn);
                }

                container.appendChild(div);

                // Draw enemy portrait after adding to DOM
                setTimeout(() => {
                    const canvas = document.getElementById(canvasId);
                    if (canvas) Portraits.drawEnemy(canvas, quest.target.enemy);
                }, 0);
            });
        }

        function claimQuest(quest) {
            quest.completed = true;
            Player.gold += quest.reward.gold;
            gainXP(quest.reward.xp);
            notify(`–ö–≤–µ—Å—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω! +${quest.reward.gold} –∑–æ–ª–æ—Ç–∞, +${quest.reward.xp} XP`, 'success');
            updateHeader();
            renderQuests();
            saveGame();
        }

        function updateQuestProgress(enemyId) {
            GameData.quests.forEach(quest => {
                if (!quest.completed && quest.target.enemy === enemyId) {
                    quest.progress++;
                }
            });
        }

        // ===================== ARENA =====================
        function renderArena() {
            // Update arena tier based on player level
            const tierNames = ['–ù–æ–≤–∏—á–æ–∫', '–ë–æ–µ—Ü', '–í–æ–∏–Ω', '–í–µ—Ç–µ—Ä–∞–Ω', '–ß–µ–º–ø–∏–æ–Ω', '–õ–µ–≥–µ–Ω–¥–∞'];
            const tierIndex = Math.min(Math.floor(Player.level / 4), tierNames.length - 1);
            document.getElementById('arena-tier').textContent = `üèÜ –†–∞–Ω–≥: ${tierNames[tierIndex]}`;

            const container = document.getElementById('enemy-list');
            container.innerHTML = '';

            GameData.enemies.forEach(enemy => {
                const div = document.createElement('div');
                div.className = 'enemy-card' + (enemy.boss ? ' boss' : '');

                // Difficulty indicator
                const levelDiff = enemy.level - Player.level;
                let diffClass, diffIcon;
                if (levelDiff <= -3) { diffClass = 'diff-easy'; diffIcon = '‚úì'; }
                else if (levelDiff <= 1) { diffClass = 'diff-medium'; diffIcon = '!'; }
                else if (levelDiff <= 4) { diffClass = 'diff-hard'; diffIcon = '!!'; }
                else { diffClass = 'diff-boss'; diffIcon = '‚ò†'; }

                const canvasId = `arena-enemy-${enemy.id}`;
                div.innerHTML = `
                    <div class="difficulty-indicator ${diffClass}">${diffIcon}</div>
                    <div class="enemy-portrait-container">
                        <canvas class="enemy-portrait" id="${canvasId}" width="120" height="120"></canvas>
                    </div>
                    <div class="enemy-card-info">
                        <div class="enemy-name">${enemy.name}</div>
                        <div class="enemy-level">‚öîÔ∏è –£—Ä–æ–≤–µ–Ω—å ${enemy.level}</div>
                        <div class="enemy-stats-mini">
                            <span class="enemy-stat enemy-stat-hp">‚ù§Ô∏è ${enemy.hp}</span>
                            <span class="enemy-stat enemy-stat-atk">‚öîÔ∏è ${enemy.attack}</span>
                            <span class="enemy-stat enemy-stat-def">üõ°Ô∏è ${enemy.defense}</span>
                        </div>
                    </div>
                    <div class="enemy-reward">
                        <span>üí∞ ${enemy.gold}</span>
                        <span>‚≠ê ${enemy.xp}</span>
                    </div>
                `;
                div.onclick = () => startBattle(enemy);
                container.appendChild(div);

                // Draw enemy portrait after adding to DOM
                setTimeout(() => {
                    const canvas = document.getElementById(canvasId);
                    if (canvas) Portraits.drawEnemy(canvas, enemy.id);
                }, 0);
            });
        }

        // ===================== BATTLE SYSTEM =====================
        function startBattle(enemy) {
            Battle.active = true;
            Battle.enemy = {...enemy};
            Battle.enemyHp = enemy.hp;
            Battle.enemyMaxHp = enemy.hp;
            Battle.playerDefending = false;
            Battle.turn = 'player';
            Battle.questEnemy = enemy.id;

            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('battle-screen').classList.add('active');

            document.getElementById('battle-player-name').textContent = Player.name;
            document.getElementById('battle-enemy-name').textContent = enemy.name;

            // Start animation system
            BattleAnim.init();
            BattleAnim.start();

            updateBattleUI();
            clearBattleLog();
            addBattleLog(`–ë–æ–π –Ω–∞—á–∞–ª—Å—è! ${enemy.name} –∞—Ç–∞–∫—É–µ—Ç!`, 'system');

            document.querySelectorAll('.battle-btn').forEach(b => b.disabled = false);
        }

        function updateBattleUI() {
            const playerHpPercent = (Player.hp / Player.maxHp) * 100;
            document.getElementById('battle-player-hp').style.width = playerHpPercent + '%';
            document.getElementById('battle-player-hp-text').textContent = `${Player.hp}/${Player.maxHp}`;

            const enemyHpPercent = (Battle.enemyHp / Battle.enemyMaxHp) * 100;
            document.getElementById('battle-enemy-hp').style.width = enemyHpPercent + '%';
            document.getElementById('battle-enemy-hp-text').textContent = `${Battle.enemyHp}/${Battle.enemyMaxHp}`;

            updateHeader();
        }

        function addBattleLog(message, type = '') {
            const log = document.getElementById('battle-log');
            const entry = document.createElement('div');
            entry.className = 'log-entry ' + type;
            entry.textContent = message;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }

        function clearBattleLog() {
            document.getElementById('battle-log').innerHTML = '';
        }

        // Battle actions
        document.querySelectorAll('.battle-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                if (Battle.turn !== 'player') return;

                const action = btn.dataset.action;
                performPlayerAction(action);
            });
        });

        function performPlayerAction(action) {
            document.querySelectorAll('.battle-btn').forEach(b => b.disabled = true);
            Battle.playerDefending = false;

            switch(action) {
                case 'attack':
                    playerAttack();
                    break;
                case 'skill':
                    playerSkill();
                    break;
                case 'defend':
                    playerDefend();
                    break;
                case 'potion':
                    usePotion();
                    break;
            }

            if (Battle.enemyHp <= 0) {
                endBattle(true);
                return;
            }

            Battle.turn = 'enemy';
            setTimeout(enemyTurn, 1000);
        }

        function playerAttack() {
            let damage = getPlayerAttack();
            const crit = Math.random() * 100 < getCritChance();
            if (crit) damage = Math.floor(damage * 1.5);

            damage = Math.max(1, damage - Battle.enemy.defense);
            Battle.enemyHp = Math.max(0, Battle.enemyHp - damage);

            // Play animations
            BattleAnim.playPlayerAttack();
            setTimeout(() => {
                BattleAnim.playEnemyHit();
                BattleAnim.showDamage(BattleAnim.enemy.baseX, 100, `-${damage}`, crit ? '#FFD700' : '#FF6B6B', crit ? 32 : 24);
            }, 400);

            addBattleLog(`–¢—ã –∞—Ç–∞–∫—É–µ—à—å –∏ –Ω–∞–Ω–æ—Å–∏—à—å ${damage} —É—Ä–æ–Ω–∞!${crit ? ' –ö–†–ò–¢!' : ''}`, 'player-action');
            updateBattleUI();
        }

        function playerSkill() {
            if (Player.mp < 20) {
                addBattleLog('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–∞–Ω—ã!', 'system');
                document.querySelectorAll('.battle-btn').forEach(b => b.disabled = false);
                return;
            }

            Player.mp -= 20;
            let damage = getPlayerAttack() + Player.stats.intelligence * 3;
            damage = Math.max(1, damage - Battle.enemy.defense / 2);
            Battle.enemyHp = Math.max(0, Battle.enemyHp - damage);

            // Play skill animation
            BattleAnim.playPlayerSkill();
            setTimeout(() => {
                BattleAnim.playEnemyHit();
                BattleAnim.showDamage(BattleAnim.enemy.baseX, 80, `-${damage}`, '#E040FB', 30);
            }, 500);

            addBattleLog(`–ú–æ—â–Ω—ã–π —É–¥–∞—Ä! ${damage} —É—Ä–æ–Ω–∞! (-20 MP)`, 'player-action');
            updateBattleUI();
        }

        function playerDefend() {
            Battle.playerDefending = true;
            const healAmount = Math.floor(Player.maxHp * 0.1);
            Player.hp = Math.min(Player.maxHp, Player.hp + healAmount);

            // Play defend animation
            BattleAnim.playPlayerDefend();
            BattleAnim.showDamage(BattleAnim.player.baseX, 100, `+${healAmount}`, '#27ae60', 22);

            addBattleLog(`–¢—ã –∑–∞—â–∏—â–∞–µ—à—å—Å—è –∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—à—å ${healAmount} HP!`, 'player-action');
            updateBattleUI();
        }

        function usePotion() {
            if (Player.potions <= 0) {
                addBattleLog('–ù–µ—Ç –∑–µ–ª–∏–π!', 'system');
                document.querySelectorAll('.battle-btn').forEach(b => b.disabled = false);
                return;
            }

            Player.potions--;
            const healAmount = 50;
            Player.hp = Math.min(Player.maxHp, Player.hp + healAmount);

            // Play heal animation
            BattleAnim.playPlayerHeal();
            BattleAnim.showDamage(BattleAnim.player.baseX, 100, `+${healAmount}`, '#27ae60', 26);

            addBattleLog(`–ò—Å–ø–æ–ª—å–∑—É–µ—à—å –∑–µ–ª—å–µ! +${healAmount} HP (–æ—Å—Ç–∞–ª–æ—Å—å: ${Player.potions})`, 'player-action');
            updateBattleUI();
        }

        function enemyTurn() {
            let damage = Battle.enemy.attack;
            if (Battle.playerDefending) damage = Math.floor(damage * 0.5);
            damage = Math.max(1, damage - getPlayerDefense());

            // Play enemy attack animation
            BattleAnim.playEnemyAttack();
            setTimeout(() => {
                BattleAnim.playPlayerHit();
                BattleAnim.showDamage(BattleAnim.player.baseX, 100, `-${damage}`, '#e74c3c', 24);
            }, 400);

            Player.hp = Math.max(0, Player.hp - damage);
            addBattleLog(`${Battle.enemy.name} –∞—Ç–∞–∫—É–µ—Ç –∏ –Ω–∞–Ω–æ—Å–∏—Ç ${damage} —É—Ä–æ–Ω–∞!`, 'enemy-action');
            updateBattleUI();

            if (Player.hp <= 0) {
                setTimeout(() => endBattle(false), 600);
                return;
            }

            Battle.turn = 'player';
            setTimeout(() => {
                document.querySelectorAll('.battle-btn').forEach(b => b.disabled = false);
            }, 600);
        }

        function endBattle(victory) {
            Battle.active = false;

            if (victory) {
                // Play enemy death animation
                BattleAnim.playEnemyDeath();
                BattleAnim.showDamage(BattleAnim.enemy.baseX, 80, 'K.O.!', '#FFD700', 36);
            }

            // Wait for death animation then show result
            setTimeout(() => {
                BattleAnim.stop();

                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById('result-screen').classList.add('active');

                const titleEl = document.getElementById('result-title');
                const rewardsEl = document.getElementById('result-rewards');

                if (victory) {
                    titleEl.textContent = '–ü–û–ë–ï–î–ê!';
                    titleEl.className = 'result-title victory';

                    Player.gold += Battle.enemy.gold;
                    updateQuestProgress(Battle.questEnemy);

                    rewardsEl.innerHTML = `
                        üí∞ +${Battle.enemy.gold} –∑–æ–ª–æ—Ç–∞<br>
                        ‚≠ê +${Battle.enemy.xp} –æ–ø—ã—Ç–∞
                    `;

                    gainXP(Battle.enemy.xp);
                } else {
                    titleEl.textContent = '–ü–û–†–ê–ñ–ï–ù–ò–ï';
                    titleEl.className = 'result-title defeat';
                    rewardsEl.textContent = '–¢—ã –±—ã–ª –ø–æ–≤–µ—Ä–∂–µ–Ω...';
                    Player.hp = Math.floor(Player.maxHp * 0.3);
                }

                updateHeader();
                saveGame();
            }, victory ? 800 : 400);
        }

        document.getElementById('continue-btn').addEventListener('click', () => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById('arena-screen').classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.querySelector('[data-screen="arena"]').classList.add('active');
        });

        function gainXP(amount) {
            Player.xp += amount;
            while (Player.xp >= Player.xpToNext) {
                Player.xp -= Player.xpToNext;
                Player.level++;
                Player.xpToNext = Math.floor(Player.xpToNext * 1.5);
                Player.statPoints += 3;
                Player.maxHp += 10;
                Player.maxMp += 5;
                Player.hp = Player.maxHp;
                Player.mp = Player.maxMp;
                notify(`–£—Ä–æ–≤–µ–Ω—å ${Player.level}! +3 –æ—á–∫–∞ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫!`, 'success');
            }
        }

        // ===================== SHOP =====================
        let currentShopTab = 'weapons';

        document.querySelectorAll('.shop-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.shop-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                renderShop(tab.dataset.tab);
            });
        });

        function renderShop(tab) {
            currentShopTab = tab;
            const container = document.getElementById('shop-items');
            container.innerHTML = '';

            let items = [];
            if (tab === 'weapons') items = GameData.weapons;
            else if (tab === 'armor') items = GameData.armor;
            else if (tab === 'potions') items = GameData.potions;

            items.forEach(item => {
                const div = document.createElement('div');
                const owned = Player.ownedItems.includes(item.id);
                const equipped = Player.equipment.weapon === item.id || Player.equipment.armor === item.id;

                div.className = 'shop-item' + (owned ? ' owned' : '') + (equipped ? ' equipped' : '');

                let statsText = '';
                if (item.attack) statsText = `+${item.attack} –ê—Ç–∞–∫–∞`;
                if (item.defense) statsText = `+${item.defense} –ó–∞—â–∏—Ç–∞`;
                if (item.heal) statsText = `+${item.heal} HP`;
                if (item.mana) statsText = `+${item.mana} MP`;

                div.innerHTML = `
                    <div class="item-icon">${item.icon}</div>
                    <div class="item-name">${item.name}</div>
                    <div class="item-stats">${statsText}</div>
                    <div class="item-price">${owned ? (equipped ? '‚úì –ù–∞–¥–µ—Ç–æ' : '–í –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ') : `üí∞ ${item.price}`}</div>
                `;

                if (tab === 'potions') {
                    const btn = document.createElement('button');
                    btn.className = 'buy-btn';
                    btn.textContent = '–ö—É–ø–∏—Ç—å';
                    btn.disabled = Player.gold < item.price;
                    btn.onclick = () => buyPotion(item);
                    div.appendChild(btn);
                } else if (!owned) {
                    const btn = document.createElement('button');
                    btn.className = 'buy-btn';
                    btn.textContent = '–ö—É–ø–∏—Ç—å';
                    btn.disabled = Player.gold < item.price;
                    btn.onclick = () => buyItem(item, tab);
                    div.appendChild(btn);
                } else if (!equipped) {
                    const btn = document.createElement('button');
                    btn.className = 'equip-btn';
                    btn.textContent = '–ù–∞–¥–µ—Ç—å';
                    btn.onclick = () => equipItem(item, tab);
                    div.appendChild(btn);
                }

                container.appendChild(div);
            });
        }

        function buyItem(item, type) {
            if (Player.gold < item.price) {
                notify('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–æ–ª–æ—Ç–∞!', 'error');
                return;
            }

            Player.gold -= item.price;
            Player.ownedItems.push(item.id);
            item.owned = true;

            notify(`–ö—É–ø–ª–µ–Ω–æ: ${item.name}!`, 'success');
            updateHeader();
            renderShop(type);
            saveGame();
        }

        function equipItem(item, type) {
            if (type === 'weapons') {
                Player.equipment.weapon = item.id;
            } else if (type === 'armor') {
                Player.equipment.armor = item.id;
            }

            notify(`–ù–∞–¥–µ—Ç–æ: ${item.name}!`, 'success');
            renderShop(type);
            saveGame();
        }

        function buyPotion(item) {
            if (Player.gold < item.price) {
                notify('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–æ–ª–æ—Ç–∞!', 'error');
                return;
            }

            Player.gold -= item.price;
            if (item.heal) Player.potions++;
            if (item.mana) Player.manaPotions++;

            notify(`–ö—É–ø–ª–µ–Ω–æ: ${item.name}!`, 'success');
            updateHeader();
            renderShop('potions');
            saveGame();
        }

        // ===================== CHARACTER =====================
        function renderCharacter() {
            document.getElementById('stat-points').textContent = Player.statPoints;

            const statsContainer = document.getElementById('stats-list');
            statsContainer.innerHTML = '';

            const statNames = {
                strength: { name: '–°–∏–ª–∞', desc: '+2 –∞—Ç–∞–∫–∏' },
                vitality: { name: '–ñ–∏–≤—É—á–µ—Å—Ç—å', desc: '+10 HP' },
                agility: { name: '–õ–æ–≤–∫–æ—Å—Ç—å', desc: '+1 –∑–∞—â–∏—Ç—ã, +1% –∫—Ä–∏—Ç' },
                intelligence: { name: '–ò–Ω—Ç–µ–ª–ª–µ–∫—Ç', desc: '+5 MP, +—É—Ä–æ–Ω —É–º–µ–Ω–∏–π' }
            };

            Object.entries(Player.stats).forEach(([key, value]) => {
                const row = document.createElement('div');
                row.className = 'stat-row';
                row.innerHTML = `
                    <div>
                        <div class="stat-name">${statNames[key].name}</div>
                        <div style="font-size: 12px; color: #a89a7a;">${statNames[key].desc}</div>
                    </div>
                    <div class="stat-row-value">
                        <div class="stat-number">${value}</div>
                        <button class="stat-up-btn" data-stat="${key}" ${Player.statPoints <= 0 ? 'disabled' : ''}>+</button>
                    </div>
                `;
                statsContainer.appendChild(row);
            });

            // Add stat button listeners
            statsContainer.querySelectorAll('.stat-up-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (Player.statPoints > 0) {
                        const stat = btn.dataset.stat;
                        Player.stats[stat]++;
                        Player.statPoints--;

                        // Apply stat effects
                        if (stat === 'vitality') {
                            Player.maxHp += 10;
                            Player.hp = Math.min(Player.hp + 10, Player.maxHp);
                        }
                        if (stat === 'intelligence') {
                            Player.maxMp += 5;
                            Player.mp = Math.min(Player.mp + 5, Player.maxMp);
                        }

                        updateHeader();
                        renderCharacter();
                        saveGame();
                    }
                });
            });

            // Equipment
            const equipContainer = document.getElementById('equipment-list');
            equipContainer.innerHTML = '';

            const weapon = GameData.weapons.find(w => w.id === Player.equipment.weapon);
            const armor = GameData.armor.find(a => a.id === Player.equipment.armor);

            equipContainer.innerHTML = `
                <div class="equip-slot">
                    <div class="slot-icon">${weapon?.icon || '‚ùì'}</div>
                    <div class="slot-info">
                        <div class="slot-label">–û—Ä—É–∂–∏–µ</div>
                        <div class="slot-item">${weapon?.name || '–ù–µ—Ç'}</div>
                        <div style="font-size: 12px; color: #4fc3f7;">+${weapon?.attack || 0} –∞—Ç–∞–∫–∏</div>
                    </div>
                </div>
                <div class="equip-slot">
                    <div class="slot-icon">${armor?.icon || '‚ùì'}</div>
                    <div class="slot-info">
                        <div class="slot-label">–ë—Ä–æ–Ω—è</div>
                        <div class="slot-item">${armor?.name || '–ù–µ—Ç'}</div>
                        <div style="font-size: 12px; color: #4fc3f7;">+${armor?.defense || 0} –∑–∞—â–∏—Ç—ã</div>
                    </div>
                </div>
                <div class="equip-slot">
                    <div class="slot-icon">üß™</div>
                    <div class="slot-info">
                        <div class="slot-label">–ó–µ–ª—å—è HP</div>
                        <div class="slot-item">${Player.potions} —à—Ç.</div>
                    </div>
                </div>
                <div style="margin-top: 20px; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 8px;">
                    <div style="margin-bottom: 10px; color: #c9a227;">–ë–æ–µ–≤—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:</div>
                    <div>–ê—Ç–∞–∫–∞: <span style="color: #4fc3f7;">${getPlayerAttack()}</span></div>
                    <div>–ó–∞—â–∏—Ç–∞: <span style="color: #4fc3f7;">${getPlayerDefense()}</span></div>
                    <div>–®–∞–Ω—Å –∫—Ä–∏—Ç–∞: <span style="color: #4fc3f7;">${getCritChance()}%</span></div>
                </div>
            `;
        }

        // ===================== INIT =====================
        function init() {
            loadGame();
            updateHeader();
            renderQuests();
            renderArena();
        }

        init();
    </script>
</body>
</html>
